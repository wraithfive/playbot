import React, { useRef } from 'react';
import { useState, useEffect, useMemo } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import { qotdApi, serverApi } from '../api/client';
import type { CreateStreamRequest, UpdateStreamRequest, ChannelTreeNodeDto } from '../types/qotd';
import { useWebSocket } from '../hooks/useWebSocket';

function ChannelTreeNode({
  node,
  level = 0,
  expandedNodes,
  onToggleExpand,
  selectedChannelId,
  onSelectChannel,
  configuredIds,
  enabledIds,
}: {
  node: ChannelTreeNodeDto;
  level?: number;
  expandedNodes: Set<string>;
  onToggleExpand: (id: string) => void;
  selectedChannelId: string;
  onSelectChannel: (id: string) => void;
  configuredIds: Set<string>;
  enabledIds: Set<string>;
}) {
  const isExpanded = expandedNodes.has(node.id);
  const hasChildren = node.children && node.children.length > 0;
  const isChannel = node.type === 'CHANNEL';
  const hasEnabled = enabledIds.has(node.id);
  const isConfigured = configuredIds.has(node.id);
  const canPost = node.canPost;

  return (
    <div style={{ marginLeft: `${level * 1}rem` }}>
      <div
        style={{
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
          padding: '0.5rem',
          borderRadius: '4px',
          cursor: 'pointer',
          backgroundColor: selectedChannelId === node.id ? 'rgba(88, 101, 242, 0.15)' : 'transparent',
          border: selectedChannelId === node.id ? '1px solid rgb(88, 101, 242)' : 'none',
          opacity: canPost ? 1 : 0.6,
        }}
      >
        {hasChildren && (
          <button
            onClick={(e) => {
              e.stopPropagation();
              onToggleExpand(node.id);
            }}
            style={{
              background: 'none',
              border: 'none',
              cursor: 'pointer',
              padding: '0',
              width: '1.5rem',
              textAlign: 'center',
              fontSize: '0.9rem',
              color: '#666',
            }}
          >
            {isExpanded ? 'â–¼' : 'â–¶'}
          </button>
        )}
        {!hasChildren && <div style={{ width: '1.5rem' }}></div>}
        <span style={{ fontSize: '1rem' }}>{isChannel ? 'ğŸ“Œ' : 'ğŸ§µ'}</span>
        <button
          onClick={() => onSelectChannel(node.id)}
          style={{
            flex: 1,
            textAlign: 'left',
            background: 'none',
            border: 'none',
            cursor: 'pointer',
            padding: '0',
            fontWeight: selectedChannelId === node.id ? '600' : '400',
            color: selectedChannelId === node.id ? 'rgb(88, 101, 242)' : 'inherit',
            display: 'flex',
            alignItems: 'center',
            gap: '0.35rem',
          }}
        >
          <span>{node.name}</span>
          {!canPost && (
            <span
              title="Bot lacks permission to post here. Grant Send Messages permission to enable."
              style={{ color: '#f59e0b', fontSize: '0.85rem' }}
            >
              âš ï¸
            </span>
          )}
          {(hasEnabled || isConfigured) && (
            <span
              title={hasEnabled ? 'Enabled stream' : 'Configured but disabled'}
              style={{
                display: 'inline-block',
                width: '8px',
                height: '8px',
                borderRadius: '50%',
                backgroundColor: hasEnabled ? '#16a34a' : '#dc2626',
              }}
            />
          )}
        </button>
      </div>
      {hasChildren && isExpanded && (
        <div>
          {node.children!.map((child) => (
            <ChannelTreeNode
              key={child.id}
              node={child}
              level={level + 1}
              expandedNodes={expandedNodes}
              onToggleExpand={onToggleExpand}
              selectedChannelId={selectedChannelId}
              onSelectChannel={onSelectChannel}
              configuredIds={configuredIds}
              enabledIds={enabledIds}
            />
          ))}
        </div>
      )}
    </div>
  );
}

export default function QotdManager() {
  const { guildId } = useParams<{ guildId: string }>();
  const navigate = useNavigate();
  const qc = useQueryClient();

  // Tree expansion state
  const [expandedNodes, setExpandedNodes] = useState<Set<string>>(new Set());
  const autoExpandedRef = useRef(false);
  
  const toggleExpandNode = (nodeId: string) => {
    const newExpanded = new Set(expandedNodes);
    if (newExpanded.has(nodeId)) {
      newExpanded.delete(nodeId);
    } else {
      newExpanded.add(nodeId);
    }
    setExpandedNodes(newExpanded);
  };

  // Channel selection state
  const [selectedChannelId, setSelectedChannelId] = useState<string>('');
  // Stream selection state
  const [selectedStreamId, setSelectedStreamId] = useState<number | null>(null);
  const [showCreateStream, setShowCreateStream] = useState(false);
  const [newStreamName, setNewStreamName] = useState('');
  // Banner state
  const [banner, setBanner] = useState<string>('');
  const [bannerLoading, setBannerLoading] = useState(false);
  const [bannerEdit, setBannerEdit] = useState(false);
  const [bannerMessage, setBannerMessage] = useState('');
  const [embedColor, setEmbedColor] = useState<number | null>(null);
  const [originalBanner, setOriginalBanner] = useState<string>('');
  const [originalEmbedColor, setOriginalEmbedColor] = useState<number | null>(null);
  const [bannerSaving, setBannerSaving] = useState(false);
  const bannerInputRef = useRef<HTMLInputElement | null>(null);
  const [showEmojiPicker, setShowEmojiPicker] = useState(false);
  const emojiPickerRef = useRef<HTMLDivElement | null>(null);
  const [selectedEmojiIndex, setSelectedEmojiIndex] = useState(0);
  const [selectedCategory, setSelectedCategory] = useState<string>('Smileys');
  const [emojiSearchQuery, setEmojiSearchQuery] = useState('');
  const [showVariations, setShowVariations] = useState<{ emoji: string; x: number; y: number } | null>(null);
  const variationTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const [recentEmojis, setRecentEmojis] = useState<string[]>(() => {
    const stored = localStorage.getItem('qotd-recent-emojis');
    return stored ? JSON.parse(stored) : [];
  });

  const toHexColor = (n: number) => `#${(n >>> 0).toString(16).padStart(6, '0').slice(-6)}`.toUpperCase();

  // Emoji variations (skin tones, gender, etc.)
  const emojiVariations: Record<string, string[]> = {
    'ğŸ‘‹': ['ğŸ‘‹', 'ğŸ‘‹ğŸ»', 'ğŸ‘‹ğŸ¼', 'ğŸ‘‹ğŸ½', 'ğŸ‘‹ğŸ¾', 'ğŸ‘‹ğŸ¿'],
    'ğŸ¤š': ['ğŸ¤š', 'ğŸ¤šğŸ»', 'ğŸ¤šğŸ¼', 'ğŸ¤šğŸ½', 'ğŸ¤šğŸ¾', 'ğŸ¤šğŸ¿'],
    'ğŸ–ï¸': ['ğŸ–ï¸', 'ğŸ–ğŸ»', 'ğŸ–ğŸ¼', 'ğŸ–ğŸ½', 'ğŸ–ğŸ¾', 'ğŸ–ğŸ¿'],
    'âœ‹': ['âœ‹', 'âœ‹ğŸ»', 'âœ‹ğŸ¼', 'âœ‹ğŸ½', 'âœ‹ğŸ¾', 'âœ‹ğŸ¿'],
    'ğŸ––': ['ğŸ––', 'ğŸ––ğŸ»', 'ğŸ––ğŸ¼', 'ğŸ––ğŸ½', 'ğŸ––ğŸ¾', 'ğŸ––ğŸ¿'],
    'ğŸ‘Œ': ['ğŸ‘Œ', 'ğŸ‘ŒğŸ»', 'ğŸ‘ŒğŸ¼', 'ğŸ‘ŒğŸ½', 'ğŸ‘ŒğŸ¾', 'ğŸ‘ŒğŸ¿'],
    'ğŸ¤Œ': ['ğŸ¤Œ', 'ğŸ¤ŒğŸ»', 'ğŸ¤ŒğŸ¼', 'ğŸ¤ŒğŸ½', 'ğŸ¤ŒğŸ¾', 'ğŸ¤ŒğŸ¿'],
    'ğŸ¤': ['ğŸ¤', 'ğŸ¤ğŸ»', 'ğŸ¤ğŸ¼', 'ğŸ¤ğŸ½', 'ğŸ¤ğŸ¾', 'ğŸ¤ğŸ¿'],
    'âœŒï¸': ['âœŒï¸', 'âœŒğŸ»', 'âœŒğŸ¼', 'âœŒğŸ½', 'âœŒğŸ¾', 'âœŒğŸ¿'],
    'ğŸ¤': ['ğŸ¤', 'ğŸ¤ğŸ»', 'ğŸ¤ğŸ¼', 'ğŸ¤ğŸ½', 'ğŸ¤ğŸ¾', 'ğŸ¤ğŸ¿'],
    'ğŸ¤Ÿ': ['ğŸ¤Ÿ', 'ğŸ¤ŸğŸ»', 'ğŸ¤ŸğŸ¼', 'ğŸ¤ŸğŸ½', 'ğŸ¤ŸğŸ¾', 'ğŸ¤ŸğŸ¿'],
    'ğŸ¤˜': ['ğŸ¤˜', 'ğŸ¤˜ğŸ»', 'ğŸ¤˜ğŸ¼', 'ğŸ¤˜ğŸ½', 'ğŸ¤˜ğŸ¾', 'ğŸ¤˜ğŸ¿'],
    'ğŸ¤™': ['ğŸ¤™', 'ğŸ¤™ğŸ»', 'ğŸ¤™ğŸ¼', 'ğŸ¤™ğŸ½', 'ğŸ¤™ğŸ¾', 'ğŸ¤™ğŸ¿'],
    'ğŸ‘ˆ': ['ğŸ‘ˆ', 'ğŸ‘ˆğŸ»', 'ğŸ‘ˆğŸ¼', 'ğŸ‘ˆğŸ½', 'ğŸ‘ˆğŸ¾', 'ğŸ‘ˆğŸ¿'],
    'ğŸ‘‰': ['ğŸ‘‰', 'ğŸ‘‰ğŸ»', 'ğŸ‘‰ğŸ¼', 'ğŸ‘‰ğŸ½', 'ğŸ‘‰ğŸ¾', 'ğŸ‘‰ğŸ¿'],
    'ğŸ‘†': ['ğŸ‘†', 'ğŸ‘†ğŸ»', 'ğŸ‘†ğŸ¼', 'ğŸ‘†ğŸ½', 'ğŸ‘†ğŸ¾', 'ğŸ‘†ğŸ¿'],
    'ğŸ–•': ['ğŸ–•', 'ğŸ–•ğŸ»', 'ğŸ–•ğŸ¼', 'ğŸ–•ğŸ½', 'ğŸ–•ğŸ¾', 'ğŸ–•ğŸ¿'],
    'ğŸ‘‡': ['ğŸ‘‡', 'ğŸ‘‡ğŸ»', 'ğŸ‘‡ğŸ¼', 'ğŸ‘‡ğŸ½', 'ğŸ‘‡ğŸ¾', 'ğŸ‘‡ğŸ¿'],
    'â˜ï¸': ['â˜ï¸', 'â˜ğŸ»', 'â˜ğŸ¼', 'â˜ğŸ½', 'â˜ğŸ¾', 'â˜ğŸ¿'],
    'ğŸ‘': ['ğŸ‘', 'ğŸ‘ğŸ»', 'ğŸ‘ğŸ¼', 'ğŸ‘ğŸ½', 'ğŸ‘ğŸ¾', 'ğŸ‘ğŸ¿'],
    'ğŸ‘': ['ğŸ‘', 'ğŸ‘ğŸ»', 'ğŸ‘ğŸ¼', 'ğŸ‘ğŸ½', 'ğŸ‘ğŸ¾', 'ğŸ‘ğŸ¿'],
    'âœŠ': ['âœŠ', 'âœŠğŸ»', 'âœŠğŸ¼', 'âœŠğŸ½', 'âœŠğŸ¾', 'âœŠğŸ¿'],
    'ğŸ‘Š': ['ğŸ‘Š', 'ğŸ‘ŠğŸ»', 'ğŸ‘ŠğŸ¼', 'ğŸ‘ŠğŸ½', 'ğŸ‘ŠğŸ¾', 'ğŸ‘ŠğŸ¿'],
    'ğŸ¤›': ['ğŸ¤›', 'ğŸ¤›ğŸ»', 'ğŸ¤›ğŸ¼', 'ğŸ¤›ğŸ½', 'ğŸ¤›ğŸ¾', 'ğŸ¤›ğŸ¿'],
    'ğŸ¤œ': ['ğŸ¤œ', 'ğŸ¤œğŸ»', 'ğŸ¤œğŸ¼', 'ğŸ¤œğŸ½', 'ğŸ¤œğŸ¾', 'ğŸ¤œğŸ¿'],
    'ğŸ‘': ['ğŸ‘', 'ğŸ‘ğŸ»', 'ğŸ‘ğŸ¼', 'ğŸ‘ğŸ½', 'ğŸ‘ğŸ¾', 'ğŸ‘ğŸ¿'],
    'ğŸ™Œ': ['ğŸ™Œ', 'ğŸ™ŒğŸ»', 'ğŸ™ŒğŸ¼', 'ğŸ™ŒğŸ½', 'ğŸ™ŒğŸ¾', 'ğŸ™ŒğŸ¿'],
    'ğŸ‘': ['ğŸ‘', 'ğŸ‘ğŸ»', 'ğŸ‘ğŸ¼', 'ğŸ‘ğŸ½', 'ğŸ‘ğŸ¾', 'ğŸ‘ğŸ¿'],
    'ğŸ¤²': ['ğŸ¤²', 'ğŸ¤²ğŸ»', 'ğŸ¤²ğŸ¼', 'ğŸ¤²ğŸ½', 'ğŸ¤²ğŸ¾', 'ğŸ¤²ğŸ¿'],
    'ğŸ¤': ['ğŸ¤', 'ğŸ¤ğŸ»', 'ğŸ¤ğŸ¼', 'ğŸ¤ğŸ½', 'ğŸ¤ğŸ¾', 'ğŸ¤ğŸ¿'],
    'ğŸ™': ['ğŸ™', 'ğŸ™ğŸ»', 'ğŸ™ğŸ¼', 'ğŸ™ğŸ½', 'ğŸ™ğŸ¾', 'ğŸ™ğŸ¿'],
    'âœï¸': ['âœï¸', 'âœğŸ»', 'âœğŸ¼', 'âœğŸ½', 'âœğŸ¾', 'âœğŸ¿'],
    'ğŸ’…': ['ğŸ’…', 'ğŸ’…ğŸ»', 'ğŸ’…ğŸ¼', 'ğŸ’…ğŸ½', 'ğŸ’…ğŸ¾', 'ğŸ’…ğŸ¿'],
    'ğŸ¤³': ['ğŸ¤³', 'ğŸ¤³ğŸ»', 'ğŸ¤³ğŸ¼', 'ğŸ¤³ğŸ½', 'ğŸ¤³ğŸ¾', 'ğŸ¤³ğŸ¿'],
    'ğŸ’ª': ['ğŸ’ª', 'ğŸ’ªğŸ»', 'ğŸ’ªğŸ¼', 'ğŸ’ªğŸ½', 'ğŸ’ªğŸ¾', 'ğŸ’ªğŸ¿'],
    'ğŸ¦µ': ['ğŸ¦µ', 'ğŸ¦µğŸ»', 'ğŸ¦µğŸ¼', 'ğŸ¦µğŸ½', 'ğŸ¦µğŸ¾', 'ğŸ¦µğŸ¿'],
    'ğŸ¦¶': ['ğŸ¦¶', 'ğŸ¦¶ğŸ»', 'ğŸ¦¶ğŸ¼', 'ğŸ¦¶ğŸ½', 'ğŸ¦¶ğŸ¾', 'ğŸ¦¶ğŸ¿'],
    'ğŸ‘‚': ['ğŸ‘‚', 'ğŸ‘‚ğŸ»', 'ğŸ‘‚ğŸ¼', 'ğŸ‘‚ğŸ½', 'ğŸ‘‚ğŸ¾', 'ğŸ‘‚ğŸ¿'],
    'ğŸ¦»': ['ğŸ¦»', 'ğŸ¦»ğŸ»', 'ğŸ¦»ğŸ¼', 'ğŸ¦»ğŸ½', 'ğŸ¦»ğŸ¾', 'ğŸ¦»ğŸ¿'],
    'ğŸ‘ƒ': ['ğŸ‘ƒ', 'ğŸ‘ƒğŸ»', 'ğŸ‘ƒğŸ¼', 'ğŸ‘ƒğŸ½', 'ğŸ‘ƒğŸ¾', 'ğŸ‘ƒğŸ¿'],
    'ğŸ‘¶': ['ğŸ‘¶', 'ğŸ‘¶ğŸ»', 'ğŸ‘¶ğŸ¼', 'ğŸ‘¶ğŸ½', 'ğŸ‘¶ğŸ¾', 'ğŸ‘¶ğŸ¿'],
    'ğŸ‘§': ['ğŸ‘§', 'ğŸ‘§ğŸ»', 'ğŸ‘§ğŸ¼', 'ğŸ‘§ğŸ½', 'ğŸ‘§ğŸ¾', 'ğŸ‘§ğŸ¿'],
    'ğŸ§’': ['ğŸ§’', 'ğŸ§’ğŸ»', 'ğŸ§’ğŸ¼', 'ğŸ§’ğŸ½', 'ğŸ§’ğŸ¾', 'ğŸ§’ğŸ¿'],
    'ğŸ‘¦': ['ğŸ‘¦', 'ğŸ‘¦ğŸ»', 'ğŸ‘¦ğŸ¼', 'ğŸ‘¦ğŸ½', 'ğŸ‘¦ğŸ¾', 'ğŸ‘¦ğŸ¿'],
    'ğŸ‘©': ['ğŸ‘©', 'ğŸ‘©ğŸ»', 'ğŸ‘©ğŸ¼', 'ğŸ‘©ğŸ½', 'ğŸ‘©ğŸ¾', 'ğŸ‘©ğŸ¿'],
    'ğŸ§‘': ['ğŸ§‘', 'ğŸ§‘ğŸ»', 'ğŸ§‘ğŸ¼', 'ğŸ§‘ğŸ½', 'ğŸ§‘ğŸ¾', 'ğŸ§‘ğŸ¿'],
    'ğŸ‘¨': ['ğŸ‘¨', 'ğŸ‘¨ğŸ»', 'ğŸ‘¨ğŸ¼', 'ğŸ‘¨ğŸ½', 'ğŸ‘¨ğŸ¾', 'ğŸ‘¨ğŸ¿'],
    'ğŸ‘±â€â™€ï¸': ['ğŸ‘±â€â™€ï¸', 'ğŸ‘±ğŸ»â€â™€ï¸', 'ğŸ‘±ğŸ¼â€â™€ï¸', 'ğŸ‘±ğŸ½â€â™€ï¸', 'ğŸ‘±ğŸ¾â€â™€ï¸', 'ğŸ‘±ğŸ¿â€â™€ï¸'],
    'ğŸ‘±': ['ğŸ‘±', 'ğŸ‘±ğŸ»', 'ğŸ‘±ğŸ¼', 'ğŸ‘±ğŸ½', 'ğŸ‘±ğŸ¾', 'ğŸ‘±ğŸ¿'],
    'ğŸ‘±â€â™‚ï¸': ['ğŸ‘±â€â™‚ï¸', 'ğŸ‘±ğŸ»â€â™‚ï¸', 'ğŸ‘±ğŸ¼â€â™‚ï¸', 'ğŸ‘±ğŸ½â€â™‚ï¸', 'ğŸ‘±ğŸ¾â€â™‚ï¸', 'ğŸ‘±ğŸ¿â€â™‚ï¸'],
    'ğŸ§”': ['ğŸ§”', 'ğŸ§”ğŸ»', 'ğŸ§”ğŸ¼', 'ğŸ§”ğŸ½', 'ğŸ§”ğŸ¾', 'ğŸ§”ğŸ¿'],
    'ğŸ‘µ': ['ğŸ‘µ', 'ğŸ‘µğŸ»', 'ğŸ‘µğŸ¼', 'ğŸ‘µğŸ½', 'ğŸ‘µğŸ¾', 'ğŸ‘µğŸ¿'],
    'ğŸ§“': ['ğŸ§“', 'ğŸ§“ğŸ»', 'ğŸ§“ğŸ¼', 'ğŸ§“ğŸ½', 'ğŸ§“ğŸ¾', 'ğŸ§“ğŸ¿'],
    'ğŸ‘´': ['ğŸ‘´', 'ğŸ‘´ğŸ»', 'ğŸ‘´ğŸ¼', 'ğŸ‘´ğŸ½', 'ğŸ‘´ğŸ¾', 'ğŸ‘´ğŸ¿'],
    'ğŸ‘²': ['ğŸ‘²', 'ğŸ‘²ğŸ»', 'ğŸ‘²ğŸ¼', 'ğŸ‘²ğŸ½', 'ğŸ‘²ğŸ¾', 'ğŸ‘²ğŸ¿'],
    'ğŸ‘³â€â™€ï¸': ['ğŸ‘³â€â™€ï¸', 'ğŸ‘³ğŸ»â€â™€ï¸', 'ğŸ‘³ğŸ¼â€â™€ï¸', 'ğŸ‘³ğŸ½â€â™€ï¸', 'ğŸ‘³ğŸ¾â€â™€ï¸', 'ğŸ‘³ğŸ¿â€â™€ï¸'],
    'ğŸ‘³': ['ğŸ‘³', 'ğŸ‘³ğŸ»', 'ğŸ‘³ğŸ¼', 'ğŸ‘³ğŸ½', 'ğŸ‘³ğŸ¾', 'ğŸ‘³ğŸ¿'],
    'ğŸ‘³â€â™‚ï¸': ['ğŸ‘³â€â™‚ï¸', 'ğŸ‘³ğŸ»â€â™‚ï¸', 'ğŸ‘³ğŸ¼â€â™‚ï¸', 'ğŸ‘³ğŸ½â€â™‚ï¸', 'ğŸ‘³ğŸ¾â€â™‚ï¸', 'ğŸ‘³ğŸ¿â€â™‚ï¸'],
    'ğŸ§•': ['ğŸ§•', 'ğŸ§•ğŸ»', 'ğŸ§•ğŸ¼', 'ğŸ§•ğŸ½', 'ğŸ§•ğŸ¾', 'ğŸ§•ğŸ¿'],
    'ğŸ‘®â€â™€ï¸': ['ğŸ‘®â€â™€ï¸', 'ğŸ‘®ğŸ»â€â™€ï¸', 'ğŸ‘®ğŸ¼â€â™€ï¸', 'ğŸ‘®ğŸ½â€â™€ï¸', 'ğŸ‘®ğŸ¾â€â™€ï¸', 'ğŸ‘®ğŸ¿â€â™€ï¸'],
    'ğŸ‘®': ['ğŸ‘®', 'ğŸ‘®ğŸ»', 'ğŸ‘®ğŸ¼', 'ğŸ‘®ğŸ½', 'ğŸ‘®ğŸ¾', 'ğŸ‘®ğŸ¿'],
    'ğŸ‘®â€â™‚ï¸': ['ğŸ‘®â€â™‚ï¸', 'ğŸ‘®ğŸ»â€â™‚ï¸', 'ğŸ‘®ğŸ¼â€â™‚ï¸', 'ğŸ‘®ğŸ½â€â™‚ï¸', 'ğŸ‘®ğŸ¾â€â™‚ï¸', 'ğŸ‘®ğŸ¿â€â™‚ï¸'],
    'ğŸ¤°': ['ğŸ¤°', 'ğŸ¤°ğŸ»', 'ğŸ¤°ğŸ¼', 'ğŸ¤°ğŸ½', 'ğŸ¤°ğŸ¾', 'ğŸ¤°ğŸ¿'],
    'ğŸ¤±': ['ğŸ¤±', 'ğŸ¤±ğŸ»', 'ğŸ¤±ğŸ¼', 'ğŸ¤±ğŸ½', 'ğŸ¤±ğŸ¾', 'ğŸ¤±ğŸ¿'],
    'ğŸ‘¼': ['ğŸ‘¼', 'ğŸ‘¼ğŸ»', 'ğŸ‘¼ğŸ¼', 'ğŸ‘¼ğŸ½', 'ğŸ‘¼ğŸ¾', 'ğŸ‘¼ğŸ¿'],
    'ğŸ…': ['ğŸ…', 'ğŸ…ğŸ»', 'ğŸ…ğŸ¼', 'ğŸ…ğŸ½', 'ğŸ…ğŸ¾', 'ğŸ…ğŸ¿'],
    'ğŸ¤¶': ['ğŸ¤¶', 'ğŸ¤¶ğŸ»', 'ğŸ¤¶ğŸ¼', 'ğŸ¤¶ğŸ½', 'ğŸ¤¶ğŸ¾', 'ğŸ¤¶ğŸ¿'],
    'ğŸ¦¸': ['ğŸ¦¸', 'ğŸ¦¸ğŸ»', 'ğŸ¦¸ğŸ¼', 'ğŸ¦¸ğŸ½', 'ğŸ¦¸ğŸ¾', 'ğŸ¦¸ğŸ¿'],
    'ğŸ¦¹': ['ğŸ¦¹', 'ğŸ¦¹ğŸ»', 'ğŸ¦¹ğŸ¼', 'ğŸ¦¹ğŸ½', 'ğŸ¦¹ğŸ¾', 'ğŸ¦¹ğŸ¿'],
    'ğŸ§™': ['ğŸ§™', 'ğŸ§™ğŸ»', 'ğŸ§™ğŸ¼', 'ğŸ§™ğŸ½', 'ğŸ§™ğŸ¾', 'ğŸ§™ğŸ¿'],
    'ğŸ§š': ['ğŸ§š', 'ğŸ§šğŸ»', 'ğŸ§šğŸ¼', 'ğŸ§šğŸ½', 'ğŸ§šğŸ¾', 'ğŸ§šğŸ¿'],
    'ğŸ§›': ['ğŸ§›', 'ğŸ§›ğŸ»', 'ğŸ§›ğŸ¼', 'ğŸ§›ğŸ½', 'ğŸ§›ğŸ¾', 'ğŸ§›ğŸ¿'],
    'ğŸ§œ': ['ğŸ§œ', 'ğŸ§œğŸ»', 'ğŸ§œğŸ¼', 'ğŸ§œğŸ½', 'ğŸ§œğŸ¾', 'ğŸ§œğŸ¿'],
    'ğŸ§': ['ğŸ§', 'ğŸ§ğŸ»', 'ğŸ§ğŸ¼', 'ğŸ§ğŸ½', 'ğŸ§ğŸ¾', 'ğŸ§ğŸ¿'],
    'ğŸ’†': ['ğŸ’†', 'ğŸ’†ğŸ»', 'ğŸ’†ğŸ¼', 'ğŸ’†ğŸ½', 'ğŸ’†ğŸ¾', 'ğŸ’†ğŸ¿'],
    'ğŸ’‡': ['ğŸ’‡', 'ğŸ’‡ğŸ»', 'ğŸ’‡ğŸ¼', 'ğŸ’‡ğŸ½', 'ğŸ’‡ğŸ¾', 'ğŸ’‡ğŸ¿'],
    'ğŸš¶': ['ğŸš¶', 'ğŸš¶ğŸ»', 'ğŸš¶ğŸ¼', 'ğŸš¶ğŸ½', 'ğŸš¶ğŸ¾', 'ğŸš¶ğŸ¿'],
    'ğŸ§': ['ğŸ§', 'ğŸ§ğŸ»', 'ğŸ§ğŸ¼', 'ğŸ§ğŸ½', 'ğŸ§ğŸ¾', 'ğŸ§ğŸ¿'],
    'ğŸ§': ['ğŸ§', 'ğŸ§ğŸ»', 'ğŸ§ğŸ¼', 'ğŸ§ğŸ½', 'ğŸ§ğŸ¾', 'ğŸ§ğŸ¿'],
    'ğŸƒ': ['ğŸƒ', 'ğŸƒğŸ»', 'ğŸƒğŸ¼', 'ğŸƒğŸ½', 'ğŸƒğŸ¾', 'ğŸƒğŸ¿'],
    'ğŸ’ƒ': ['ğŸ’ƒ', 'ğŸ’ƒğŸ»', 'ğŸ’ƒğŸ¼', 'ğŸ’ƒğŸ½', 'ğŸ’ƒğŸ¾', 'ğŸ’ƒğŸ¿'],
    'ğŸ•º': ['ğŸ•º', 'ğŸ•ºğŸ»', 'ğŸ•ºğŸ¼', 'ğŸ•ºğŸ½', 'ğŸ•ºğŸ¾', 'ğŸ•ºğŸ¿'],
    'ğŸ•´ï¸': ['ğŸ•´ï¸', 'ğŸ•´ğŸ»', 'ğŸ•´ğŸ¼', 'ğŸ•´ğŸ½', 'ğŸ•´ğŸ¾', 'ğŸ•´ğŸ¿'],
    'ğŸ§–': ['ğŸ§–', 'ğŸ§–ğŸ»', 'ğŸ§–ğŸ¼', 'ğŸ§–ğŸ½', 'ğŸ§–ğŸ¾', 'ğŸ§–ğŸ¿'],
    'ğŸ§—': ['ğŸ§—', 'ğŸ§—ğŸ»', 'ğŸ§—ğŸ¼', 'ğŸ§—ğŸ½', 'ğŸ§—ğŸ¾', 'ğŸ§—ğŸ¿'],
    'ğŸ‡': ['ğŸ‡', 'ğŸ‡ğŸ»', 'ğŸ‡ğŸ¼', 'ğŸ‡ğŸ½', 'ğŸ‡ğŸ¾', 'ğŸ‡ğŸ¿'],
    'â›·ï¸': ['â›·ï¸', 'â›·ğŸ»', 'â›·ğŸ¼', 'â›·ğŸ½', 'â›·ğŸ¾', 'â›·ğŸ¿'],
    'ğŸ‚': ['ğŸ‚', 'ğŸ‚ğŸ»', 'ğŸ‚ğŸ¼', 'ğŸ‚ğŸ½', 'ğŸ‚ğŸ¾', 'ğŸ‚ğŸ¿'],
    'ğŸŒï¸': ['ğŸŒï¸', 'ğŸŒğŸ»', 'ğŸŒğŸ¼', 'ğŸŒğŸ½', 'ğŸŒğŸ¾', 'ğŸŒğŸ¿'],
    'ğŸ„': ['ğŸ„', 'ğŸ„ğŸ»', 'ğŸ„ğŸ¼', 'ğŸ„ğŸ½', 'ğŸ„ğŸ¾', 'ğŸ„ğŸ¿'],
    'ğŸš£': ['ğŸš£', 'ğŸš£ğŸ»', 'ğŸš£ğŸ¼', 'ğŸš£ğŸ½', 'ğŸš£ğŸ¾', 'ğŸš£ğŸ¿'],
    'ğŸŠ': ['ğŸŠ', 'ğŸŠğŸ»', 'ğŸŠğŸ¼', 'ğŸŠğŸ½', 'ğŸŠğŸ¾', 'ğŸŠğŸ¿'],
    'â›¹ï¸': ['â›¹ï¸', 'â›¹ğŸ»', 'â›¹ğŸ¼', 'â›¹ğŸ½', 'â›¹ğŸ¾', 'â›¹ğŸ¿'],
    'ğŸ‹ï¸': ['ğŸ‹ï¸', 'ğŸ‹ğŸ»', 'ğŸ‹ğŸ¼', 'ğŸ‹ğŸ½', 'ğŸ‹ğŸ¾', 'ğŸ‹ğŸ¿'],
    'ğŸš´': ['ğŸš´', 'ğŸš´ğŸ»', 'ğŸš´ğŸ¼', 'ğŸš´ğŸ½', 'ğŸš´ğŸ¾', 'ğŸš´ğŸ¿'],
    'ğŸšµ': ['ğŸšµ', 'ğŸšµğŸ»', 'ğŸšµğŸ¼', 'ğŸšµğŸ½', 'ğŸšµğŸ¾', 'ğŸšµğŸ¿'],
    'ğŸ¤¸': ['ğŸ¤¸', 'ğŸ¤¸ğŸ»', 'ğŸ¤¸ğŸ¼', 'ğŸ¤¸ğŸ½', 'ğŸ¤¸ğŸ¾', 'ğŸ¤¸ğŸ¿'],
    'ğŸ¤¼': ['ğŸ¤¼', 'ğŸ¤¼ğŸ»', 'ğŸ¤¼ğŸ¼', 'ğŸ¤¼ğŸ½', 'ğŸ¤¼ğŸ¾', 'ğŸ¤¼ğŸ¿'],
    'ğŸ¤½': ['ğŸ¤½', 'ğŸ¤½ğŸ»', 'ğŸ¤½ğŸ¼', 'ğŸ¤½ğŸ½', 'ğŸ¤½ğŸ¾', 'ğŸ¤½ğŸ¿'],
    'ğŸ¤¾': ['ğŸ¤¾', 'ğŸ¤¾ğŸ»', 'ğŸ¤¾ğŸ¼', 'ğŸ¤¾ğŸ½', 'ğŸ¤¾ğŸ¾', 'ğŸ¤¾ğŸ¿'],
    'ğŸ¤¹': ['ğŸ¤¹', 'ğŸ¤¹ğŸ»', 'ğŸ¤¹ğŸ¼', 'ğŸ¤¹ğŸ½', 'ğŸ¤¹ğŸ¾', 'ğŸ¤¹ğŸ¿'],
    'ğŸ§˜': ['ğŸ§˜', 'ğŸ§˜ğŸ»', 'ğŸ§˜ğŸ¼', 'ğŸ§˜ğŸ½', 'ğŸ§˜ğŸ¾', 'ğŸ§˜ğŸ¿'],
    'ğŸ›€': ['ğŸ›€', 'ğŸ›€ğŸ»', 'ğŸ›€ğŸ¼', 'ğŸ›€ğŸ½', 'ğŸ›€ğŸ¾', 'ğŸ›€ğŸ¿'],
    'ğŸ›Œ': ['ğŸ›Œ', 'ğŸ›ŒğŸ»', 'ğŸ›ŒğŸ¼', 'ğŸ›ŒğŸ½', 'ğŸ›ŒğŸ¾', 'ğŸ›ŒğŸ¿'],
    // Hearts with different colors
    'â¤ï¸': ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”'],
    // Common gestures/symbols
    'ğŸ˜€': ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚'],
  };

  // Simple emoji keyword mapping for search
  const emojiKeywords: Record<string, string> = {
    'ğŸ˜€': 'smile happy grin',
    'ğŸ˜ƒ': 'smile happy joy',
    'ğŸ˜„': 'smile happy laugh',
    'ğŸ˜': 'grin smile happy',
    'ğŸ˜†': 'laugh smile happy',
    'ğŸ˜…': 'sweat smile nervous',
    'ğŸ¤£': 'laugh rolling floor',
    'ğŸ˜‚': 'laugh tears joy cry',
    'â¤ï¸': 'heart love red',
    'ğŸ§¡': 'heart love orange',
    'ğŸ’›': 'heart love yellow',
    'ğŸ’š': 'heart love green',
    'ğŸ’™': 'heart love blue',
    'ğŸ’œ': 'heart love purple',
    'ğŸ–¤': 'heart love black',
    'ğŸ¤': 'heart love white',
    'ğŸ¤': 'heart love brown',
    'ğŸ‘': 'thumbs up good yes',
    'ğŸ‘': 'thumbs down bad no',
    'ğŸ‘': 'clap applause',
    'ğŸ™': 'pray thanks please',
    'ğŸ’ª': 'muscle strong flex',
    'ğŸ”¥': 'fire hot lit',
    'ğŸ’¯': 'hundred perfect',
    'âœ…': 'check yes done',
    'âŒ': 'x no cross',
    'â­': 'star favorite',
    'ğŸŒŸ': 'star sparkle glow',
    'âœ¨': 'sparkle shine',
    'ğŸ‰': 'party celebrate',
    'ğŸŠ': 'party confetti',
    'ğŸ†': 'trophy winner champion',
    'ğŸ¥‡': 'gold medal first',
    'ğŸ¥ˆ': 'silver medal second',
    'ğŸ¥‰': 'bronze medal third',
    // Skin tone emojis
    'ğŸ‘‹ğŸ»': 'wave light skin tone',
    'ğŸ‘‹ğŸ¼': 'wave medium light skin tone',
    'ğŸ‘‹ğŸ½': 'wave medium skin tone',
    'ğŸ‘‹ğŸ¾': 'wave medium dark skin tone',
    'ğŸ‘‹ğŸ¿': 'wave dark skin tone',
    'ğŸ‘ğŸ»': 'thumbs up light skin tone',
    'ğŸ‘ğŸ¼': 'thumbs up medium light skin tone',
    'ğŸ‘ğŸ½': 'thumbs up medium skin tone',
    'ğŸ‘ğŸ¾': 'thumbs up medium dark skin tone',
    'ğŸ‘ğŸ¿': 'thumbs up dark skin tone',
  };

  const getFilteredEmojis = () => {
    if (!emojiSearchQuery.trim()) {
      return EMOJI_CATEGORIES[selectedCategory];
    }
    
    const query = emojiSearchQuery.toLowerCase();
    const allEmojis = Object.values(EMOJI_CATEGORIES).flat();
    
    return allEmojis.filter(emoji => {
      const keywords = emojiKeywords[emoji] || '';
      return keywords.toLowerCase().includes(query) || emoji.includes(query);
    });
  };

  const applyFormat = (token: string) => {
    const input = bannerInputRef.current;
    if (!input) return;
    const start = input.selectionStart ?? 0;
    const end = input.selectionEnd ?? 0;
    const value = banner;
    if (start === end) {
      const insert = token + token;
      const newVal = value.slice(0, start) + insert + value.slice(end);
      setBanner(newVal);
      // place cursor between tokens
      const caret = start + token.length;
      setTimeout(() => {
        input.focus();
        input.setSelectionRange(caret, caret);
      }, 0);
    } else {
      const selected = value.slice(start, end);
      const newVal = value.slice(0, start) + token + selected + token + value.slice(end);
      setBanner(newVal);
      // keep selection including tokens
      const newStart = start + token.length;
      const newEnd = end + token.length;
      setTimeout(() => {
        input.focus();
        input.setSelectionRange(newStart, newEnd);
      }, 0);
    }
  };

  // Comprehensive emoji categories
  const EMOJI_CATEGORIES: Record<string, string[]> = {
    'Smileys': [
      'ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ¤£','ğŸ˜‚','ğŸ™‚','ğŸ™ƒ','ğŸ« ','ğŸ˜‰','ğŸ˜Š','ğŸ˜‡','ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜—','â˜ºï¸','ğŸ˜š','ğŸ˜™','ğŸ¥²',
      'ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ«¢','ğŸ«£','ğŸ¤«','ğŸ¤”','ğŸ«¡','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ«¥','ğŸ˜¶â€ğŸŒ«ï¸','ğŸ˜','ğŸ˜’','ğŸ™„',
      'ğŸ˜¬','ğŸ˜®â€ğŸ’¨','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ¥µ','ğŸ¥¶','ğŸ¥´','ğŸ˜µ','ğŸ˜µâ€ğŸ’«','ğŸ¤¯','ğŸ¤ ','ğŸ¥³',
      'ğŸ¥¸','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ«¤','ğŸ˜Ÿ','ğŸ™','â˜¹ï¸','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ¥¹','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±',
      'ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ¥±','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ‘¾','ğŸ¤–'
    ],
    'Gestures': [
      'ğŸ‘‹','ğŸ¤š','ğŸ–ï¸','âœ‹','ğŸ––','ğŸ«±','ğŸ«²','ğŸ«³','ğŸ«´','ğŸ‘Œ','ğŸ¤Œ','ğŸ¤','âœŒï¸','ğŸ¤','ğŸ«°','ğŸ¤Ÿ','ğŸ¤˜','ğŸ¤™','ğŸ‘ˆ','ğŸ‘‰','ğŸ‘†','ğŸ–•','ğŸ‘‡',
      'â˜ï¸','ğŸ«µ','ğŸ‘','ğŸ‘','âœŠ','ğŸ‘Š','ğŸ¤›','ğŸ¤œ','ğŸ‘','ğŸ™Œ','ğŸ«¶','ğŸ‘','ğŸ¤²','ğŸ¤','ğŸ™','âœï¸','ğŸ’…','ğŸ¤³','ğŸ’ª','ğŸ¦¾','ğŸ¦¿','ğŸ¦µ','ğŸ¦¶',
      'ğŸ‘‚','ğŸ¦»','ğŸ‘ƒ','ğŸ§ ','ğŸ«€','ğŸ«','ğŸ¦·','ğŸ¦´','ğŸ‘€','ğŸ‘ï¸','ğŸ‘…','ğŸ‘„','ğŸ«¦','ğŸ’‹'
    ],
    'People': [
      'ğŸ‘¶','ğŸ‘§','ğŸ§’','ğŸ‘¦','ğŸ‘©','ğŸ§‘','ğŸ‘¨','ğŸ‘©â€ğŸ¦±','ğŸ§‘â€ğŸ¦±','ğŸ‘¨â€ğŸ¦±','ğŸ‘©â€ğŸ¦°','ğŸ§‘â€ğŸ¦°','ğŸ‘¨â€ğŸ¦°','ğŸ‘±â€â™€ï¸','ğŸ‘±','ğŸ‘±â€â™‚ï¸','ğŸ‘©â€ğŸ¦³','ğŸ§‘â€ğŸ¦³','ğŸ‘¨â€ğŸ¦³',
      'ğŸ‘©â€ğŸ¦²','ğŸ§‘â€ğŸ¦²','ğŸ‘¨â€ğŸ¦²','ğŸ§”â€â™€ï¸','ğŸ§”','ğŸ§”â€â™‚ï¸','ğŸ‘µ','ğŸ§“','ğŸ‘´','ğŸ‘²','ğŸ‘³â€â™€ï¸','ğŸ‘³','ğŸ‘³â€â™‚ï¸','ğŸ§•','ğŸ‘®â€â™€ï¸','ğŸ‘®','ğŸ‘®â€â™‚ï¸','ğŸ‘·â€â™€ï¸','ğŸ‘·','ğŸ‘·â€â™‚ï¸',
      'ğŸ’‚â€â™€ï¸','ğŸ’‚','ğŸ’‚â€â™‚ï¸','ğŸ•µï¸â€â™€ï¸','ğŸ•µï¸','ğŸ•µï¸â€â™‚ï¸','ğŸ‘©â€âš•ï¸','ğŸ§‘â€âš•ï¸','ğŸ‘¨â€âš•ï¸','ğŸ‘©â€ğŸŒ¾','ğŸ§‘â€ğŸŒ¾','ğŸ‘¨â€ğŸŒ¾','ğŸ‘©â€ğŸ³','ğŸ§‘â€ğŸ³','ğŸ‘¨â€ğŸ³','ğŸ‘©â€ğŸ“','ğŸ§‘â€ğŸ“','ğŸ‘¨â€ğŸ“',
      'ğŸ‘©â€ğŸ¤','ğŸ§‘â€ğŸ¤','ğŸ‘¨â€ğŸ¤','ğŸ‘©â€ğŸ«','ğŸ§‘â€ğŸ«','ğŸ‘¨â€ğŸ«','ğŸ‘©â€ğŸ­','ğŸ§‘â€ğŸ­','ğŸ‘¨â€ğŸ­','ğŸ‘©â€ğŸ’»','ğŸ§‘â€ğŸ’»','ğŸ‘¨â€ğŸ’»','ğŸ‘©â€ğŸ’¼','ğŸ§‘â€ğŸ’¼','ğŸ‘¨â€ğŸ’¼','ğŸ‘©â€ğŸ”§','ğŸ§‘â€ğŸ”§','ğŸ‘¨â€ğŸ”§',
      'ğŸ‘©â€ğŸ”¬','ğŸ§‘â€ğŸ”¬','ğŸ‘¨â€ğŸ”¬','ğŸ‘©â€ğŸ¨','ğŸ§‘â€ğŸ¨','ğŸ‘¨â€ğŸ¨','ğŸ‘©â€ğŸš’','ğŸ§‘â€ğŸš’','ğŸ‘¨â€ğŸš’','ğŸ‘©â€âœˆï¸','ğŸ§‘â€âœˆï¸','ğŸ‘¨â€âœˆï¸','ğŸ‘©â€ğŸš€','ğŸ§‘â€ğŸš€','ğŸ‘¨â€ğŸš€','ğŸ‘©â€âš–ï¸','ğŸ§‘â€âš–ï¸','ğŸ‘¨â€âš–ï¸',
      'ğŸ‘°â€â™€ï¸','ğŸ‘°','ğŸ‘°â€â™‚ï¸','ğŸ¤µâ€â™€ï¸','ğŸ¤µ','ğŸ¤µâ€â™‚ï¸','ğŸ‘¸','ğŸ¤´','ğŸ¥·','ğŸ¦¸â€â™€ï¸','ğŸ¦¸','ğŸ¦¸â€â™‚ï¸','ğŸ¦¹â€â™€ï¸','ğŸ¦¹','ğŸ¦¹â€â™‚ï¸','ğŸ¤¶','ğŸ§‘â€ğŸ„','ğŸ…',
      'ğŸ§™â€â™€ï¸','ğŸ§™','ğŸ§™â€â™‚ï¸','ğŸ§â€â™€ï¸','ğŸ§','ğŸ§â€â™‚ï¸','ğŸ§›â€â™€ï¸','ğŸ§›','ğŸ§›â€â™‚ï¸','ğŸ§Ÿâ€â™€ï¸','ğŸ§Ÿ','ğŸ§Ÿâ€â™‚ï¸','ğŸ§â€â™€ï¸','ğŸ§','ğŸ§â€â™‚ï¸','ğŸ§œâ€â™€ï¸','ğŸ§œ','ğŸ§œâ€â™‚ï¸',
      'ğŸ§šâ€â™€ï¸','ğŸ§š','ğŸ§šâ€â™‚ï¸','ğŸ‘¼','ğŸ¤°','ğŸ«ƒ','ğŸ«„','ğŸ¤±','ğŸ‘©â€ğŸ¼','ğŸ§‘â€ğŸ¼','ğŸ‘¨â€ğŸ¼'
    ],
    'Animals': [
      'ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ»â€â„ï¸','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ½','ğŸ¸','ğŸµ','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ’','ğŸ”','ğŸ§',
      'ğŸ¦','ğŸ¤','ğŸ£','ğŸ¥','ğŸ¦†','ğŸ¦…','ğŸ¦‰','ğŸ¦‡','ğŸº','ğŸ—','ğŸ´','ğŸ¦„','ğŸ','ğŸª±','ğŸ›','ğŸ¦‹','ğŸŒ','ğŸ','ğŸœ','ğŸª°','ğŸª²','ğŸª³','ğŸ¦Ÿ','ğŸ¦—',
      'ğŸ•·ï¸','ğŸ•¸ï¸','ğŸ¦‚','ğŸ¢','ğŸ','ğŸ¦','ğŸ¦–','ğŸ¦•','ğŸ™','ğŸ¦‘','ğŸ¦','ğŸ¦','ğŸ¦€','ğŸ¡','ğŸ ','ğŸŸ','ğŸ¬','ğŸ³','ğŸ‹','ğŸ¦ˆ','ğŸŠ','ğŸ…','ğŸ†','ğŸ¦“',
      'ğŸ¦','ğŸ¦§','ğŸ¦£','ğŸ˜','ğŸ¦›','ğŸ¦','ğŸª','ğŸ«','ğŸ¦’','ğŸ¦˜','ğŸ¦¬','ğŸƒ','ğŸ‚','ğŸ„','ğŸ','ğŸ–','ğŸ','ğŸ‘','ğŸ¦™','ğŸ','ğŸ¦Œ','ğŸ•','ğŸ©','ğŸ¦®',
      'ğŸ•â€ğŸ¦º','ğŸˆ','ğŸˆâ€â¬›','ğŸª¶','ğŸ“','ğŸ¦ƒ','ğŸ¦¤','ğŸ¦š','ğŸ¦œ','ğŸ¦¢','ğŸ¦©','ğŸ•Šï¸','ğŸ‡','ğŸ¦','ğŸ¦¨','ğŸ¦¡','ğŸ¦«','ğŸ¦¦','ğŸ¦¥','ğŸ','ğŸ€','ğŸ¿ï¸','ğŸ¦”'
    ],
    'Food': [
      'ğŸ‡','ğŸˆ','ğŸ‰','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ','ğŸ¥­','ğŸ','ğŸ','ğŸ','ğŸ‘','ğŸ’','ğŸ“','ğŸ«','ğŸ¥','ğŸ…','ğŸ«’','ğŸ¥¥','ğŸ¥‘','ğŸ†','ğŸ¥”','ğŸ¥•','ğŸŒ½',
      'ğŸŒ¶ï¸','ğŸ«‘','ğŸ¥’','ğŸ¥¬','ğŸ¥¦','ğŸ§„','ğŸ§…','ğŸ„','ğŸ¥œ','ğŸ«˜','ğŸŒ°','ğŸ','ğŸ¥','ğŸ¥–','ğŸ«“','ğŸ¥¨','ğŸ¥¯','ğŸ¥','ğŸ§‡','ğŸ§€','ğŸ–','ğŸ—','ğŸ¥©','ğŸ¥“',
      'ğŸ”','ğŸŸ','ğŸ•','ğŸŒ­','ğŸ¥ª','ğŸŒ®','ğŸŒ¯','ğŸ«”','ğŸ¥™','ğŸ§†','ğŸ¥š','ğŸ³','ğŸ¥˜','ğŸ²','ğŸ«•','ğŸ¥£','ğŸ¥—','ğŸ¿','ğŸ§ˆ','ğŸ§‚','ğŸ¥«','ğŸ±','ğŸ˜','ğŸ™',
      'ğŸš','ğŸ›','ğŸœ','ğŸ','ğŸ ','ğŸ¢','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¥®','ğŸ¡','ğŸ¥Ÿ','ğŸ¥ ','ğŸ¥¡','ğŸ¦€','ğŸ¦','ğŸ¦','ğŸ¦‘','ğŸ¦ª','ğŸ¦','ğŸ§','ğŸ¨','ğŸ©','ğŸª',
      'ğŸ‚','ğŸ°','ğŸ§','ğŸ¥§','ğŸ«','ğŸ¬','ğŸ­','ğŸ®','ğŸ¯','ğŸ¼','ğŸ¥›','â˜•','ğŸ«–','ğŸµ','ğŸ¶','ğŸ¾','ğŸ·','ğŸ¸','ğŸ¹','ğŸº','ğŸ»','ğŸ¥‚','ğŸ¥ƒ','ğŸ«—',
      'ğŸ¥¤','ğŸ§‹','ğŸ§ƒ','ğŸ§‰','ğŸ§Š'
    ],
    'Activities': [
      'âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¥','ğŸ¾','ğŸ','ğŸ‰','ğŸ¥','ğŸ±','ğŸª€','ğŸ“','ğŸ¸','ğŸ’','ğŸ‘','ğŸ¥','ğŸ','ğŸªƒ','ğŸ¥…','â›³','ğŸª','ğŸ¹','ğŸ£','ğŸ¤¿',
      'ğŸ¥Š','ğŸ¥‹','ğŸ½','ğŸ›¹','ğŸ›¼','ğŸ›·','â›¸ï¸','ğŸ¥Œ','ğŸ¿','â›·ï¸','ğŸ‚','ğŸª‚','ğŸ‹ï¸â€â™€ï¸','ğŸ‹ï¸','ğŸ‹ï¸â€â™‚ï¸','ğŸ¤¼â€â™€ï¸','ğŸ¤¼','ğŸ¤¼â€â™‚ï¸','ğŸ¤¸â€â™€ï¸','ğŸ¤¸','ğŸ¤¸â€â™‚ï¸',
      'â›¹ï¸â€â™€ï¸','â›¹ï¸','â›¹ï¸â€â™‚ï¸','ğŸ¤º','ğŸ¤¾â€â™€ï¸','ğŸ¤¾','ğŸ¤¾â€â™‚ï¸','ğŸŒï¸â€â™€ï¸','ğŸŒï¸','ğŸŒï¸â€â™‚ï¸','ğŸ‡','ğŸ§˜â€â™€ï¸','ğŸ§˜','ğŸ§˜â€â™‚ï¸','ğŸ„â€â™€ï¸','ğŸ„','ğŸ„â€â™‚ï¸','ğŸŠâ€â™€ï¸','ğŸŠ','ğŸŠâ€â™‚ï¸',
      'ğŸ¤½â€â™€ï¸','ğŸ¤½','ğŸ¤½â€â™‚ï¸','ğŸš£â€â™€ï¸','ğŸš£','ğŸš£â€â™‚ï¸','ğŸ§—â€â™€ï¸','ğŸ§—','ğŸ§—â€â™‚ï¸','ğŸšµâ€â™€ï¸','ğŸšµ','ğŸšµâ€â™‚ï¸','ğŸš´â€â™€ï¸','ğŸš´','ğŸš´â€â™‚ï¸','ğŸ†','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸ…',
      'ğŸ–ï¸','ğŸµï¸','ğŸ—ï¸','ğŸ«','ğŸŸï¸','ğŸª','ğŸ¤¹','ğŸ¤¹â€â™€ï¸','ğŸ¤¹â€â™‚ï¸','ğŸ­','ğŸ©°','ğŸ¨','ğŸ¬','ğŸ¤','ğŸ§','ğŸ¼','ğŸ¹','ğŸ¥','ğŸª˜','ğŸ·','ğŸº','ğŸª—','ğŸ¸',
      'ğŸª•','ğŸ»','ğŸ²','â™Ÿï¸','ğŸ¯','ğŸ³','ğŸ®','ğŸ°','ğŸ§©'
    ],
    'Travel': [
      'ğŸš—','ğŸš•','ğŸš™','ğŸšŒ','ğŸš','ğŸï¸','ğŸš“','ğŸš‘','ğŸš’','ğŸš','ğŸ›»','ğŸšš','ğŸš›','ğŸšœ','ğŸ¦¯','ğŸ¦½','ğŸ¦¼','ğŸ›´','ğŸš²','ğŸ›µ','ğŸï¸','ğŸ›º','ğŸš¨','ğŸš”',
      'ğŸš','ğŸš˜','ğŸš–','ğŸš¡','ğŸš ','ğŸšŸ','ğŸšƒ','ğŸš‹','ğŸš','ğŸš','ğŸš„','ğŸš…','ğŸšˆ','ğŸš‚','ğŸš†','ğŸš‡','ğŸšŠ','ğŸš‰','âœˆï¸','ğŸ›«','ğŸ›¬','ğŸ›©ï¸','ğŸ’º','ğŸ›°ï¸',
      'ğŸš€','ğŸ›¸','ğŸš','ğŸ›¶','â›µ','ğŸš¤','ğŸ›¥ï¸','ğŸ›³ï¸','â›´ï¸','ğŸš¢','âš“','ğŸª','â›½','ğŸš§','ğŸš¦','ğŸš¥','ğŸš','ğŸ—ºï¸','ğŸ—¿','ğŸ—½','ğŸ—¼','ğŸ°','ğŸ¯','ğŸŸï¸',
      'ğŸ¡','ğŸ¢','ğŸ ','â›²','â›±ï¸','ğŸ–ï¸','ğŸï¸','ğŸœï¸','ğŸŒ‹','â›°ï¸','ğŸ”ï¸','ğŸ—»','ğŸ•ï¸','â›º','ğŸ›–','ğŸ ','ğŸ¡','ğŸ˜ï¸','ğŸšï¸','ğŸ—ï¸','ğŸ­','ğŸ¢','ğŸ¬',
      'ğŸ£','ğŸ¤','ğŸ¥','ğŸ¦','ğŸ¨','ğŸª','ğŸ«','ğŸ©','ğŸ’’','ğŸ›ï¸','â›ª','ğŸ•Œ','ğŸ•','ğŸ›•','ğŸ•‹','â›©ï¸','ğŸ›¤ï¸','ğŸ›£ï¸','ğŸ—¾','ğŸ‘','ğŸï¸','ğŸŒ…','ğŸŒ„',
      'ğŸŒ ','ğŸ‡','ğŸ†','ğŸŒ‡','ğŸŒ†','ğŸ™ï¸','ğŸŒƒ','ğŸŒŒ','ğŸŒ‰','ğŸŒ'
    ],
    'Objects': [
      'âŒš','ğŸ“±','ğŸ“²','ğŸ’»','âŒ¨ï¸','ğŸ–¥ï¸','ğŸ–¨ï¸','ğŸ–±ï¸','ğŸ–²ï¸','ğŸ•¹ï¸','ğŸ—œï¸','ğŸ’¾','ğŸ’¿','ğŸ“€','ğŸ“¼','ğŸ“·','ğŸ“¸','ğŸ“¹','ğŸ¥','ğŸ“½ï¸','ğŸï¸','ğŸ“','â˜ï¸',
      'ğŸ“Ÿ','ğŸ“ ','ğŸ“º','ğŸ“»','ğŸ™ï¸','ğŸšï¸','ğŸ›ï¸','ğŸ§­','â±ï¸','â²ï¸','â°','ğŸ•°ï¸','âŒ›','â³','ğŸ“¡','ğŸ”‹','ğŸ”Œ','ğŸ’¡','ğŸ”¦','ğŸ•¯ï¸','ğŸª”','ğŸ§¯','ğŸ›¢ï¸',
      'ğŸ’¸','ğŸ’µ','ğŸ’´','ğŸ’¶','ğŸ’·','ğŸª™','ğŸ’°','ğŸ’³','ğŸªª','ğŸ’','âš–ï¸','ğŸªœ','ğŸ§°','ğŸª›','ğŸ”§','ğŸ”¨','âš’ï¸','ğŸ› ï¸','â›ï¸','ğŸªš','ğŸ”©','âš™ï¸','ğŸª¤','ğŸ§±',
      'â›“ï¸','ğŸ§²','ğŸ”«','ğŸ’£','ğŸ§¨','ğŸª“','ğŸ”ª','ğŸ—¡ï¸','âš”ï¸','ğŸ›¡ï¸','ğŸš¬','âš°ï¸','ğŸª¦','âš±ï¸','ğŸº','ğŸ”®','ğŸ“¿','ğŸ§¿','ğŸ’ˆ','âš—ï¸','ğŸ”­','ğŸ”¬','ğŸ•³ï¸',
      'ğŸ©¹','ğŸ©º','ğŸ’Š','ğŸ’‰','ğŸ©¸','ğŸ§¬','ğŸ¦ ','ğŸ§«','ğŸ§ª','ğŸŒ¡ï¸','ğŸ§¹','ğŸª ','ğŸ§º','ğŸ§»','ğŸš½','ğŸš°','ğŸš¿','ğŸ›','ğŸ›€','ğŸ§¼','ğŸª¥','ğŸª’','ğŸ§½','ğŸª£',
      'ğŸ§´','ğŸ›ï¸','ğŸ”‘','ğŸ—ï¸','ğŸšª','ğŸª‘','ğŸ›‹ï¸','ğŸ›ï¸','ğŸ›Œ','ğŸ§¸','ğŸª†','ğŸ–¼ï¸','ğŸª','ğŸªŸ','ğŸ›ï¸','ğŸ›’','ğŸ','ğŸˆ','ğŸ','ğŸ€','ğŸª„','ğŸª…','ğŸŠ',
      'ğŸ‰','ğŸ','ğŸ®','ğŸ','ğŸ§§','âœ‰ï¸','ğŸ“©','ğŸ“¨','ğŸ“§','ğŸ’Œ','ğŸ“¥','ğŸ“¤','ğŸ“¦','ğŸ·ï¸','ğŸª§','ğŸ“ª','ğŸ“«','ğŸ“¬','ğŸ“­','ğŸ“®','ğŸ“¯','ğŸ“œ','ğŸ“ƒ',
      'ğŸ“„','ğŸ“‘','ğŸ§¾','ğŸ“Š','ğŸ“ˆ','ğŸ“‰','ğŸ—’ï¸','ğŸ—“ï¸','ğŸ“†','ğŸ“…','ğŸ—‘ï¸','ğŸ“‡','ğŸ—ƒï¸','ğŸ—³ï¸','ğŸ—„ï¸','ğŸ“‹','ğŸ“','ğŸ“‚','ğŸ—‚ï¸','ğŸ—ï¸','ğŸ“°','ğŸ““','ğŸ“”',
      'ğŸ“’','ğŸ“•','ğŸ“—','ğŸ“˜','ğŸ“™','ğŸ“š','ğŸ“–','ğŸ”–','ğŸ§·','ğŸ”—','ğŸ“','ğŸ–‡ï¸','ğŸ“','ğŸ“','ğŸ§®','ğŸ“Œ','ğŸ“','âœ‚ï¸','ğŸ–Šï¸','ğŸ–‹ï¸','âœ’ï¸','ğŸ–Œï¸','ğŸ–ï¸',
      'ğŸ“','âœï¸','ğŸ”','ğŸ”','ğŸ”','ğŸ”','ğŸ”’','ğŸ”“'
    ],
    'Symbols': [
      'â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â¤ï¸â€ğŸ”¥','â¤ï¸â€ğŸ©¹','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ’Ÿ','â˜®ï¸',
      'âœï¸','â˜ªï¸','ğŸ•‰ï¸','â˜¸ï¸','âœ¡ï¸','ğŸ”¯','ğŸ•','â˜¯ï¸','â˜¦ï¸','ğŸ›','â›','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™','â™','â™','â™‘','â™’','â™“','ğŸ†”',
      'âš›ï¸','ğŸ‰‘','â˜¢ï¸','â˜£ï¸','ğŸ“´','ğŸ“³','ğŸˆ¶','ğŸˆš','ğŸˆ¸','ğŸˆº','ğŸˆ·ï¸','âœ´ï¸','ğŸ†š','ğŸ’®','ğŸ‰','ãŠ™ï¸','ãŠ—ï¸','ğŸˆ´','ğŸˆµ','ğŸˆ¹','ğŸˆ²','ğŸ…°ï¸','ğŸ…±ï¸',
      'ğŸ†','ğŸ†‘','ğŸ…¾ï¸','ğŸ†˜','âŒ','â­•','ğŸ›‘','â›”','ğŸ“›','ğŸš«','ğŸ’¯','ğŸ’¢','â™¨ï¸','ğŸš·','ğŸš¯','ğŸš³','ğŸš±','ğŸ”','ğŸ“µ','ğŸš­','â—','â•','â“',
      'â”','â€¼ï¸','â‰ï¸','ğŸ”…','ğŸ”†','ã€½ï¸','âš ï¸','ğŸš¸','ğŸ”±','âšœï¸','ğŸ”°','â™»ï¸','âœ…','ğŸˆ¯','ğŸ’¹','â‡ï¸','âœ³ï¸','â','ğŸŒ','ğŸ’ ','â“‚ï¸','ğŸŒ€','ğŸ’¤',
      'ğŸ§','ğŸš¾','â™¿','ğŸ…¿ï¸','ğŸ›—','ğŸˆ³','ğŸˆ‚ï¸','ğŸ›‚','ğŸ›ƒ','ğŸ›„','ğŸ›…','ğŸš¹','ğŸšº','ğŸš¼','âš§ï¸','ğŸš»','ğŸš®','ğŸ¦','ğŸ“¶','ğŸˆ','ğŸ”£','â„¹ï¸','ğŸ”¤',
      'ğŸ”¡','ğŸ” ','ğŸ†–','ğŸ†—','ğŸ†™','ğŸ†’','ğŸ†•','ğŸ†“','0ï¸âƒ£','1ï¸âƒ£','2ï¸âƒ£','3ï¸âƒ£','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£','7ï¸âƒ£','8ï¸âƒ£','9ï¸âƒ£','ğŸ”Ÿ','ğŸ”¢','#ï¸âƒ£','*ï¸âƒ£',
      'âï¸','â–¶ï¸','â¸ï¸','â¯ï¸','â¹ï¸','âºï¸','â­ï¸','â®ï¸','â©','âª','â«','â¬','â—€ï¸','ğŸ”¼','ğŸ”½','â¡ï¸','â¬…ï¸','â¬†ï¸','â¬‡ï¸','â†—ï¸','â†˜ï¸','â†™ï¸','â†–ï¸',
      'â†•ï¸','â†”ï¸','â†ªï¸','â†©ï¸','â¤´ï¸','â¤µï¸','ğŸ”€','ğŸ”','ğŸ”‚','ğŸ”„','ğŸ”ƒ','ğŸµ','ğŸ¶','â•','â–','â—','âœ–ï¸','ğŸŸ°','â™¾ï¸','ğŸ’²','ğŸ’±','â„¢ï¸','Â©ï¸',
      'Â®ï¸','ã€°ï¸','â°','â¿','ğŸ”š','ğŸ”™','ğŸ”›','ğŸ”','ğŸ”œ','âœ”ï¸','â˜‘ï¸','ğŸ”˜','ğŸ”´','ğŸŸ ','ğŸŸ¡','ğŸŸ¢','ğŸ”µ','ğŸŸ£','âš«','âšª','ğŸŸ¤','ğŸ”º','ğŸ”»',
      'ğŸ”¸','ğŸ”¹','ğŸ”¶','ğŸ”·','ğŸ”³','ğŸ”²','â–ªï¸','â–«ï¸','â—¾','â—½','â—¼ï¸','â—»ï¸','ğŸŸ¥','ğŸŸ§','ğŸŸ¨','ğŸŸ©','ğŸŸ¦','ğŸŸª','â¬›','â¬œ','ğŸŸ«','ğŸ”ˆ','ğŸ”‡',
      'ğŸ”‰','ğŸ”Š','ğŸ””','ğŸ”•','ğŸ“£','ğŸ“¢','ğŸ’¬','ğŸ’­','ğŸ—¯ï¸','â™ ï¸','â™£ï¸','â™¥ï¸','â™¦ï¸','ğŸƒ','ğŸ´','ğŸ€„','ğŸ•','ğŸ•‘','ğŸ•’','ğŸ•“','ğŸ•”','ğŸ••','ğŸ•–',
      'ğŸ•—','ğŸ•˜','ğŸ•™','ğŸ•š','ğŸ•›','ğŸ•œ','ğŸ•','ğŸ•','ğŸ•Ÿ','ğŸ• ','ğŸ•¡','ğŸ•¢','ğŸ•£','ğŸ•¤','ğŸ•¥','ğŸ•¦','ğŸ•§'
    ],
    'Nature': [
      'ğŸŒ','ğŸŒ','ğŸŒ','ğŸŒ','ğŸ—ºï¸','ğŸ—¾','ğŸ§­','ğŸ”ï¸','â›°ï¸','ğŸŒ‹','ğŸ—»','ğŸ•ï¸','ğŸ–ï¸','ğŸœï¸','ğŸï¸','ğŸï¸','ğŸŸï¸','ğŸ›ï¸','ğŸ—ï¸','ğŸ§±','ğŸª¨','ğŸªµ',
      'ğŸ›–','ğŸ˜ï¸','ğŸšï¸','ğŸ ','ğŸ¡','ğŸ¢','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¦','ğŸ¨','ğŸ©','ğŸª','ğŸ«','ğŸ¬','ğŸ­','ğŸ¯','ğŸ°','ğŸ’’','ğŸ—¼','ğŸ—½','â›ª','ğŸ•Œ',
      'ğŸ›•','ğŸ•','â›©ï¸','ğŸ•‹','â›²','â›º','ğŸŒ','ğŸŒƒ','ğŸ™ï¸','ğŸŒ„','ğŸŒ…','ğŸŒ†','ğŸŒ‡','ğŸŒ‰','â™¨ï¸','ğŸ ','ğŸ¡','ğŸ¢','ğŸ’ˆ','ğŸª','ğŸš‚','ğŸšƒ','ğŸš„',
      'ğŸš…','ğŸš†','ğŸš‡','ğŸšˆ','ğŸš‰','ğŸšŠ','ğŸš','ğŸš','ğŸš‹','ğŸšŒ','ğŸš','ğŸš','ğŸš','ğŸš‘','ğŸš’','ğŸš“','ğŸš”','ğŸš•','ğŸš–','ğŸš—','ğŸš˜','ğŸš™','ğŸ›»',
      'ğŸšš','ğŸš›','ğŸšœ','ğŸï¸','ğŸï¸','ğŸ›µ','ğŸ¦½','ğŸ¦¼','ğŸ›º','ğŸš²','ğŸ›´','ğŸ›¹','ğŸ›¼','ğŸš','ğŸ›£ï¸','ğŸ›¤ï¸','ğŸ›¢ï¸','â›½','ğŸ›','ğŸš¨','ğŸš¥','ğŸš¦',
      'ğŸ›‘','ğŸš§','âš“','ğŸ›Ÿ','â›µ','ğŸ›¶','ğŸš¤','ğŸ›³ï¸','â›´ï¸','ğŸ›¥ï¸','ğŸš¢','âœˆï¸','ğŸ›©ï¸','ğŸ›«','ğŸ›¬','ğŸª‚','ğŸ’º','ğŸš','ğŸšŸ','ğŸš ','ğŸš¡','ğŸ›°ï¸',
      'ğŸš€','ğŸ›¸','ğŸ›ï¸','ğŸ§³','âŒ›','â³','âŒš','â°','â±ï¸','â²ï¸','ğŸ•°ï¸','ğŸ•›','ğŸ•§','ğŸ•','ğŸ•œ','ğŸ•‘','ğŸ•','ğŸ•’','ğŸ•','ğŸ•“','ğŸ•Ÿ','ğŸ•”','ğŸ• ',
      'ğŸ••','ğŸ•¡','ğŸ•–','ğŸ•¢','ğŸ•—','ğŸ•£','ğŸ•˜','ğŸ•¤','ğŸ•™','ğŸ•¥','ğŸ•š','ğŸ•¦','ğŸŒ‘','ğŸŒ’','ğŸŒ“','ğŸŒ”','ğŸŒ•','ğŸŒ–','ğŸŒ—','ğŸŒ˜','ğŸŒ™','ğŸŒš','ğŸŒ›',
      'ğŸŒœ','ğŸŒ¡ï¸','â˜€ï¸','ğŸŒ','ğŸŒ','ğŸª','â­','ğŸŒŸ','ğŸŒ ','ğŸŒŒ','â˜ï¸','â›…','â›ˆï¸','ğŸŒ¤ï¸','ğŸŒ¥ï¸','ğŸŒ¦ï¸','ğŸŒ§ï¸','ğŸŒ¨ï¸','ğŸŒ©ï¸','ğŸŒªï¸','ğŸŒ«ï¸','ğŸŒ¬ï¸',
      'ğŸŒ€','ğŸŒˆ','ğŸŒ‚','â˜‚ï¸','â˜”','â›±ï¸','âš¡','â„ï¸','â˜ƒï¸','â›„','â˜„ï¸','ğŸ”¥','ğŸ’§','ğŸŒŠ','ğŸƒ','ğŸ„','ğŸ†','ğŸ‡','ğŸ§¨','âœ¨','ğŸˆ','ğŸ‰','ğŸŠ',
      'ğŸ‹','ğŸ','ğŸ','ğŸ','ğŸ','ğŸ‘','ğŸ§§','ğŸ€','ğŸ','ğŸ—ï¸','ğŸŸï¸','ğŸ«','ğŸ–ï¸','ğŸ†','ğŸ…','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'
    ],
    'Flags': [
      'ğŸ','ğŸš©','ğŸŒ','ğŸ´','ğŸ³ï¸','ğŸ³ï¸â€ğŸŒˆ','ğŸ³ï¸â€âš§ï¸','ğŸ´â€â˜ ï¸','ğŸ‡¦ğŸ‡¨','ğŸ‡¦ğŸ‡©','ğŸ‡¦ğŸ‡ª','ğŸ‡¦ğŸ‡«','ğŸ‡¦ğŸ‡¬','ğŸ‡¦ğŸ‡®','ğŸ‡¦ğŸ‡±','ğŸ‡¦ğŸ‡²','ğŸ‡¦ğŸ‡´','ğŸ‡¦ğŸ‡¶','ğŸ‡¦ğŸ‡·','ğŸ‡¦ğŸ‡¸','ğŸ‡¦ğŸ‡¹','ğŸ‡¦ğŸ‡º',
      'ğŸ‡¦ğŸ‡¼','ğŸ‡¦ğŸ‡½','ğŸ‡¦ğŸ‡¿','ğŸ‡§ğŸ‡¦','ğŸ‡§ğŸ‡§','ğŸ‡§ğŸ‡©','ğŸ‡§ğŸ‡ª','ğŸ‡§ğŸ‡«','ğŸ‡§ğŸ‡¬','ğŸ‡§ğŸ‡­','ğŸ‡§ğŸ‡®','ğŸ‡§ğŸ‡¯','ğŸ‡§ğŸ‡±','ğŸ‡§ğŸ‡²','ğŸ‡§ğŸ‡³','ğŸ‡§ğŸ‡´','ğŸ‡§ğŸ‡¶','ğŸ‡§ğŸ‡·','ğŸ‡§ğŸ‡¸','ğŸ‡§ğŸ‡¹','ğŸ‡§ğŸ‡»','ğŸ‡§ğŸ‡¼',
      'ğŸ‡§ğŸ‡¾','ğŸ‡§ğŸ‡¿','ğŸ‡¨ğŸ‡¦','ğŸ‡¨ğŸ‡¨','ğŸ‡¨ğŸ‡©','ğŸ‡¨ğŸ‡«','ğŸ‡¨ğŸ‡¬','ğŸ‡¨ğŸ‡­','ğŸ‡¨ğŸ‡®','ğŸ‡¨ğŸ‡°','ğŸ‡¨ğŸ‡±','ğŸ‡¨ğŸ‡²','ğŸ‡¨ğŸ‡³','ğŸ‡¨ğŸ‡´','ğŸ‡¨ğŸ‡µ','ğŸ‡¨ğŸ‡·','ğŸ‡¨ğŸ‡º','ğŸ‡¨ğŸ‡»','ğŸ‡¨ğŸ‡¼','ğŸ‡¨ğŸ‡½','ğŸ‡¨ğŸ‡¾','ğŸ‡¨ğŸ‡¿',
      'ğŸ‡©ğŸ‡ª','ğŸ‡©ğŸ‡¬','ğŸ‡©ğŸ‡¯','ğŸ‡©ğŸ‡°','ğŸ‡©ğŸ‡²','ğŸ‡©ğŸ‡´','ğŸ‡©ğŸ‡¿','ğŸ‡ªğŸ‡¦','ğŸ‡ªğŸ‡¨','ğŸ‡ªğŸ‡ª','ğŸ‡ªğŸ‡¬','ğŸ‡ªğŸ‡­','ğŸ‡ªğŸ‡·','ğŸ‡ªğŸ‡¸','ğŸ‡ªğŸ‡¹','ğŸ‡ªğŸ‡º','ğŸ‡«ğŸ‡®','ğŸ‡«ğŸ‡¯','ğŸ‡«ğŸ‡°','ğŸ‡«ğŸ‡²','ğŸ‡«ğŸ‡´','ğŸ‡«ğŸ‡·',
      'ğŸ‡¬ğŸ‡¦','ğŸ‡¬ğŸ‡§','ğŸ‡¬ğŸ‡©','ğŸ‡¬ğŸ‡ª','ğŸ‡¬ğŸ‡«','ğŸ‡¬ğŸ‡¬','ğŸ‡¬ğŸ‡­','ğŸ‡¬ğŸ‡®','ğŸ‡¬ğŸ‡±','ğŸ‡¬ğŸ‡²','ğŸ‡¬ğŸ‡³','ğŸ‡¬ğŸ‡µ','ğŸ‡¬ğŸ‡¶','ğŸ‡¬ğŸ‡·','ğŸ‡¬ğŸ‡¸','ğŸ‡¬ğŸ‡¹','ğŸ‡¬ğŸ‡º','ğŸ‡¬ğŸ‡¼','ğŸ‡¬ğŸ‡¾','ğŸ‡­ğŸ‡°','ğŸ‡­ğŸ‡²','ğŸ‡­ğŸ‡³',
      'ğŸ‡­ğŸ‡·','ğŸ‡­ğŸ‡¹','ğŸ‡­ğŸ‡º','ğŸ‡®ğŸ‡¨','ğŸ‡®ğŸ‡©','ğŸ‡®ğŸ‡ª','ğŸ‡®ğŸ‡±','ğŸ‡®ğŸ‡²','ğŸ‡®ğŸ‡³','ğŸ‡®ğŸ‡´','ğŸ‡®ğŸ‡¶','ğŸ‡®ğŸ‡·','ğŸ‡®ğŸ‡¸','ğŸ‡®ğŸ‡¹','ğŸ‡¯ğŸ‡ª','ğŸ‡¯ğŸ‡²','ğŸ‡¯ğŸ‡´','ğŸ‡¯ğŸ‡µ','ğŸ‡°ğŸ‡ª','ğŸ‡°ğŸ‡¬','ğŸ‡°ğŸ‡­','ğŸ‡°ğŸ‡®',
      'ğŸ‡°ğŸ‡²','ğŸ‡°ğŸ‡³','ğŸ‡°ğŸ‡µ','ğŸ‡°ğŸ‡·','ğŸ‡°ğŸ‡¼','ğŸ‡°ğŸ‡¾','ğŸ‡°ğŸ‡¿','ğŸ‡±ğŸ‡¦','ğŸ‡±ğŸ‡§','ğŸ‡±ğŸ‡¨','ğŸ‡±ğŸ‡®','ğŸ‡±ğŸ‡°','ğŸ‡±ğŸ‡·','ğŸ‡±ğŸ‡¸','ğŸ‡±ğŸ‡¹','ğŸ‡±ğŸ‡º','ğŸ‡±ğŸ‡»','ğŸ‡±ğŸ‡¾','ğŸ‡²ğŸ‡¦','ğŸ‡²ğŸ‡¨','ğŸ‡²ğŸ‡©','ğŸ‡²ğŸ‡ª',
      'ğŸ‡²ğŸ‡«','ğŸ‡²ğŸ‡¬','ğŸ‡²ğŸ‡­','ğŸ‡²ğŸ‡°','ğŸ‡²ğŸ‡±','ğŸ‡²ğŸ‡²','ğŸ‡²ğŸ‡³','ğŸ‡²ğŸ‡´','ğŸ‡²ğŸ‡µ','ğŸ‡²ğŸ‡¶','ğŸ‡²ğŸ‡·','ğŸ‡²ğŸ‡¸','ğŸ‡²ğŸ‡¹','ğŸ‡²ğŸ‡º','ğŸ‡²ğŸ‡»','ğŸ‡²ğŸ‡¼','ğŸ‡²ğŸ‡½','ğŸ‡²ğŸ‡¾','ğŸ‡²ğŸ‡¿','ğŸ‡³ğŸ‡¦','ğŸ‡³ğŸ‡¨','ğŸ‡³ğŸ‡ª',
      'ğŸ‡³ğŸ‡«','ğŸ‡³ğŸ‡¬','ğŸ‡³ğŸ‡®','ğŸ‡³ğŸ‡±','ğŸ‡³ğŸ‡´','ğŸ‡³ğŸ‡µ','ğŸ‡³ğŸ‡·','ğŸ‡³ğŸ‡º','ğŸ‡³ğŸ‡¿','ğŸ‡´ğŸ‡²','ğŸ‡µğŸ‡¦','ğŸ‡µğŸ‡ª','ğŸ‡µğŸ‡«','ğŸ‡µğŸ‡¬','ğŸ‡µğŸ‡­','ğŸ‡µğŸ‡°','ğŸ‡µğŸ‡±','ğŸ‡µğŸ‡²','ğŸ‡µğŸ‡³','ğŸ‡µğŸ‡·','ğŸ‡µğŸ‡¸','ğŸ‡µğŸ‡¹',
      'ğŸ‡µğŸ‡¼','ğŸ‡µğŸ‡¾','ğŸ‡¶ğŸ‡¦','ğŸ‡·ğŸ‡ª','ğŸ‡·ğŸ‡´','ğŸ‡·ğŸ‡¸','ğŸ‡·ğŸ‡º','ğŸ‡·ğŸ‡¼','ğŸ‡¸ğŸ‡¦','ğŸ‡¸ğŸ‡§','ğŸ‡¸ğŸ‡¨','ğŸ‡¸ğŸ‡©','ğŸ‡¸ğŸ‡ª','ğŸ‡¸ğŸ‡¬','ğŸ‡¸ğŸ‡­','ğŸ‡¸ğŸ‡®','ğŸ‡¸ğŸ‡¯','ğŸ‡¸ğŸ‡°','ğŸ‡¸ğŸ‡±','ğŸ‡¸ğŸ‡²','ğŸ‡¸ğŸ‡³','ğŸ‡¸ğŸ‡´',
      'ğŸ‡¸ğŸ‡·','ğŸ‡¸ğŸ‡¸','ğŸ‡¸ğŸ‡¹','ğŸ‡¸ğŸ‡»','ğŸ‡¸ğŸ‡½','ğŸ‡¸ğŸ‡¾','ğŸ‡¸ğŸ‡¿','ğŸ‡¹ğŸ‡¦','ğŸ‡¹ğŸ‡¨','ğŸ‡¹ğŸ‡©','ğŸ‡¹ğŸ‡«','ğŸ‡¹ğŸ‡¬','ğŸ‡¹ğŸ‡­','ğŸ‡¹ğŸ‡¯','ğŸ‡¹ğŸ‡°','ğŸ‡¹ğŸ‡±','ğŸ‡¹ğŸ‡²','ğŸ‡¹ğŸ‡³','ğŸ‡¹ğŸ‡´','ğŸ‡¹ğŸ‡·','ğŸ‡¹ğŸ‡¹','ğŸ‡¹ğŸ‡»',
      'ğŸ‡¹ğŸ‡¼','ğŸ‡¹ğŸ‡¿','ğŸ‡ºğŸ‡¦','ğŸ‡ºğŸ‡¬','ğŸ‡ºğŸ‡²','ğŸ‡ºğŸ‡³','ğŸ‡ºğŸ‡¸','ğŸ‡ºğŸ‡¾','ğŸ‡ºğŸ‡¿','ğŸ‡»ğŸ‡¦','ğŸ‡»ğŸ‡¨','ğŸ‡»ğŸ‡ª','ğŸ‡»ğŸ‡¬','ğŸ‡»ğŸ‡®','ğŸ‡»ğŸ‡³','ğŸ‡»ğŸ‡º','ğŸ‡¼ğŸ‡«','ğŸ‡¼ğŸ‡¸','ğŸ‡½ğŸ‡°','ğŸ‡¾ğŸ‡ª','ğŸ‡¾ğŸ‡¹','ğŸ‡¿ğŸ‡¦',
      'ğŸ‡¿ğŸ‡²','ğŸ‡¿ğŸ‡¼','ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿','ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿','ğŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿'
    ]
  };

  const handleEmojiMouseDown = (emoji: string, event: React.MouseEvent<HTMLButtonElement>) => {
    const variations = emojiVariations[emoji];
    if (!variations || variations.length <= 1) return;
    
    const rect = event.currentTarget.getBoundingClientRect();
    variationTimeoutRef.current = setTimeout(() => {
      setShowVariations({
        emoji,
        x: rect.left,
        y: rect.top - 50 // Show above the emoji
      });
    }, 500); // 500ms long-press
  };

  const handleEmojiMouseUp = () => {
    if (variationTimeoutRef.current) {
      clearTimeout(variationTimeoutRef.current);
      variationTimeoutRef.current = null;
    }
  };

  const handleEmojiClick = (emoji: string, keepOpen: boolean) => {
    // Only insert if not showing variations
    if (!showVariations) {
      insertEmoji(emoji, keepOpen);
    }
  };

  const insertEmoji = (emoji: string, keepOpen = false) => {
    const input = bannerInputRef.current;
    if (!input) return;
    const start = input.selectionStart ?? banner.length;
    const end = input.selectionEnd ?? banner.length;
    const newVal = banner.slice(0, start) + emoji + banner.slice(end);
    setBanner(newVal);
    const caret = start + emoji.length;
    
    // Update recent emojis
    setRecentEmojis(prev => {
      const updated = [emoji, ...prev.filter(e => e !== emoji)].slice(0, 12);
      localStorage.setItem('qotd-recent-emojis', JSON.stringify(updated));
      return updated;
    });
    
    // Close variations menu
    setShowVariations(null);
    
    if (!keepOpen) {
      setShowEmojiPicker(false);
    }
    
    setTimeout(() => {
      input.focus();
      input.setSelectionRange(caret, caret);
    }, 0);
  };

  useEffect(() => {
    const onClickOutside = (e: MouseEvent) => {
      if (!showEmojiPicker) return;
      const target = e.target as Node;
      if (
        emojiPickerRef.current &&
        !emojiPickerRef.current.contains(target) &&
        !(bannerInputRef.current && bannerInputRef.current.contains(target))
      ) {
        setShowEmojiPicker(false);
        setShowVariations(null);
      }
      // Close variations if clicking outside
      if (showVariations && emojiPickerRef.current?.contains(target)) {
        const isVariationButton = (target as HTMLElement).closest('.emoji-variations-popup');
        if (!isVariationButton) {
          setShowVariations(null);
        }
      }
    };
    
    const onKeyDown = (e: KeyboardEvent) => {
      if (!showEmojiPicker) return;
      
      const currentEmojis = emojiSearchQuery ? getFilteredEmojis() : EMOJI_CATEGORIES[selectedCategory];
      const allEmojis = (!emojiSearchQuery && selectedCategory === 'Smileys') ? [...recentEmojis, ...currentEmojis] : currentEmojis;
      const cols = 10;
      
      if (e.key === 'Escape') {
        e.preventDefault();
        setShowEmojiPicker(false);
        bannerInputRef.current?.focus();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (allEmojis[selectedEmojiIndex]) {
          insertEmoji(allEmojis[selectedEmojiIndex], e.shiftKey);
        }
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        setSelectedEmojiIndex(prev => Math.min(prev + 1, allEmojis.length - 1));
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        setSelectedEmojiIndex(prev => Math.max(prev - 1, 0));
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        setSelectedEmojiIndex(prev => Math.min(prev + cols, allEmojis.length - 1));
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        setSelectedEmojiIndex(prev => Math.max(prev - cols, 0));
      } else if (e.key === 'Tab') {
        e.preventDefault();
        if (e.shiftKey) {
          setSelectedEmojiIndex(prev => prev === 0 ? allEmojis.length - 1 : prev - 1);
        } else {
          setSelectedEmojiIndex(prev => (prev + 1) % allEmojis.length);
        }
      }
    };
    
    document.addEventListener('mousedown', onClickOutside);
    document.addEventListener('keydown', onKeyDown);
    return () => {
      document.removeEventListener('mousedown', onClickOutside);
      document.removeEventListener('keydown', onKeyDown);
    };
  }, [showEmojiPicker, selectedEmojiIndex, recentEmojis, selectedCategory, emojiSearchQuery, EMOJI_CATEGORIES, getFilteredEmojis]);

  useEffect(() => {
    if (guildId && selectedChannelId && selectedStreamId) {
      setBannerLoading(true);
      Promise.all([
        qotdApi.getStreamBanner(guildId, selectedChannelId, selectedStreamId),
        qotdApi.getStreamBannerColor(guildId, selectedChannelId, selectedStreamId),
        qotdApi.getStreamBannerMention(guildId, selectedChannelId, selectedStreamId)
      ])
        .then(([textRes, colorRes, mentionRes]) => {
          const text = textRes.data;
          const color = colorRes.data ?? 0x9B59B6;
          const mention = (mentionRes.data ?? '') as string;
          setBanner(text);
          setEmbedColor(color);
          setOriginalBanner(text);
          setOriginalEmbedColor(color);
          setMentionTarget(mention || '');
        })
        .catch(() => {
          setBanner('â“â“ Question of the Day â“â“');
          setEmbedColor(0x9B59B6);
          setOriginalBanner('â“â“ Question of the Day â“â“');
          setOriginalEmbedColor(0x9B59B6);
          setMentionTarget('');
        })
        .finally(() => setBannerLoading(false));
    }
  }, [guildId, selectedChannelId, selectedStreamId]);
  const [csvFile, setCsvFile] = useState<File | null>(null);
  const [newQuestion, setNewQuestion] = useState('');
  const [configMessage, setConfigMessage] = useState('');
  const [questionMessage, setQuestionMessage] = useState('');

  interface ScheduleEntry {
    id: number;
    days: Set<string>;
    time: string;
  }

  const [schedules, setSchedules] = useState<ScheduleEntry[]>([
    { id: 1, days: new Set(['MON', 'TUE', 'WED', 'THU', 'FRI']), time: '09:00' }
  ]);
  const [showAdvanced, setShowAdvanced] = useState(false);

  // Fetch available channels and threads as tree structure
  const { data: channels } = useQuery({
    queryKey: ['qotd-channel-options', guildId],
    queryFn: async () => (await serverApi.getChannelOptions(guildId!)),
    enabled: !!guildId,
  });

  // Fetch all configured channels/threads (guild-wide) to mark configured nodes
  const { data: configs } = useQuery({
    queryKey: ['qotd-configs', guildId],
    queryFn: async () => await qotdApi.listConfigs(guildId!),
    enabled: !!guildId,
  });

  // channelTree is already in tree structure from getChannelOptions
  const channelTree = channels || [];

  // channel/thread id -> name lookup
  const channelNameMap = useMemo(() => {
    const map = new Map<string, string>();
    const walk = (nodes: ChannelTreeNodeDto[]) => {
      nodes.forEach((node) => {
        map.set(node.id, node.name);
        if (node.children && node.children.length > 0) {
          walk(node.children);
        }
      });
    };
    walk(channelTree);
    return map;
  }, [channelTree]);

  // Collect all node ids for expand-all and for stream summary queries
  const allNodeIds = useMemo(() => {
    const ids: string[] = [];
    const walk = (nodes: ChannelTreeNodeDto[]) => {
      nodes.forEach((node) => {
        ids.push(node.id);
        if (node.children && node.children.length > 0) {
          walk(node.children);
        }
      });
    };
    walk(channelTree);
    return ids;
  }, [channelTree]);

  // Fetch stream status for all nodes in one batch call
  const { data: streamStatus } = useQuery({
    queryKey: ['qotd-stream-status', guildId],
    queryFn: async () => await qotdApi.getStreamStatus(guildId!),
    enabled: !!guildId && allNodeIds.length > 0,
    staleTime: 0, // always fresh per load
  });

  // Enabled streams set
  const enabledIds = useMemo(() => {
    const set = new Set<string>();
    streamStatus?.forEach((status) => {
      if (status.hasEnabled) set.add(status.channelId);
    });
    return set;
  }, [streamStatus]);

  // Configured (regardless of enabled) set from batch status
  const configuredIds = useMemo(() => {
    const set = new Set<string>();
    streamStatus?.forEach((status) => {
      if (status.hasConfigured) set.add(status.channelId);
    });
    configs?.forEach((c) => set.add(c.channelId));
    return set;
  }, [configs, streamStatus]);

  // Compute channels that have enabled descendants for auto-expand on load
  const channelsWithEnabledThreads = useMemo(() => {
    const toExpand = new Set<string>();
    const walk = (nodes: ChannelTreeNodeDto[], parentId?: string) => {
      nodes.forEach((node) => {
        if (enabledIds.has(node.id)) {
          // This node is enabled; mark parent for expansion
          if (parentId) toExpand.add(parentId);
        }
        if (node.children && node.children.length > 0) {
          walk(node.children, node.id);
        }
      });
    };
    walk(channelTree);
    return toExpand;
  }, [channelTree, enabledIds]);

  // Auto-expand channels with enabled threads on first data load
  useEffect(() => {
    if (!autoExpandedRef.current && channelsWithEnabledThreads.size > 0) {
      setExpandedNodes((prev) => new Set([...prev, ...channelsWithEnabledThreads]));
      autoExpandedRef.current = true;
    }
  }, [channelsWithEnabledThreads]);

  // Fetch streams for selected channel
  const { data: streams } = useQuery({
    queryKey: ['qotd-streams', guildId, selectedChannelId],
    queryFn: async () => await qotdApi.listStreams(guildId!, selectedChannelId!),
    enabled: !!guildId && !!selectedChannelId,
  });

  // Auto-select first stream when streams load
  useEffect(() => {
    if (streams && streams.length > 0 && !selectedStreamId) {
      setSelectedStreamId(streams[0].id);
    }
  }, [streams, selectedStreamId]);

  // Fetch config for selected channel (DEPRECATED - keeping for backward compat display)
  const { data: config } = useQuery({
    queryKey: ['qotd-config', guildId, selectedChannelId],
    queryFn: async () => await qotdApi.getConfig(guildId!, selectedChannelId!),
    enabled: false, // Disabled - config now comes from selected stream
  });

  // Fetch questions for selected stream (WebSocket handles real-time updates)
  const { data: questions } = useQuery({
    queryKey: ['qotd-stream-questions', guildId, selectedChannelId, selectedStreamId],
    queryFn: async () => await qotdApi.listStreamQuestions(guildId!, selectedChannelId!, selectedStreamId!),
    enabled: !!guildId && !!selectedChannelId && !!selectedStreamId,
  });

  // Fetch guild-wide pending submissions (WebSocket handles real-time updates)
  const { data: submissions } = useQuery({
    queryKey: ['qotd-submissions', guildId],
    queryFn: async () => await qotdApi.listPending(guildId!),
    enabled: !!guildId,
  });

  const [form, setForm] = useState<UpdateStreamRequest>({
    streamName: '',
    enabled: false,
    timezone: 'UTC',
    randomize: false,
    autoApprove: false,
  });
  // Mention UX state
  const [mentionTarget, setMentionTarget] = useState<string>('');
  const [mentionError, setMentionError] = useState<string | null>(null);
  const [mentionWarnings, setMentionWarnings] = useState<string[]>([]);

  // Parse cron expression back to days and time
  const parseCron = (cron: string | undefined): { days: string[], time: string } => {
    if (!cron) return { days: ['MON','TUE','WED','THU','FRI'], time: '09:00' };
    
    // Quartz format: sec min hour day-of-month month day-of-week
    // Example: "0 0 9 ? * MON,TUE,WED,THU,FRI"
    const parts = cron.trim().split(/\s+/);
    if (parts.length < 6) return { days: ['MON','TUE','WED','THU','FRI'], time: '09:00' };
    
    const minute = parts[1];
    const hour = parts[2];
    const dayOfWeek = parts[5];
    
    const time = `${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
    const days = dayOfWeek.split(',').map(d => d.trim().toUpperCase());
    
    return { days, time };
  };

  // Helpers: normalize and validate mention
  const normalizeMention = (raw: string): string => {
    const v = (raw || '').trim();
    if (!v) return '';
    if (v.toLowerCase() === '@everyone' || v.toLowerCase() === '@here') return v.toLowerCase();
    // Already valid mention formats
    if (/^<@!?\d+>$/.test(v)) return v; // user
    if (/^<@&\d+>$/.test(v)) return v; // role
    if (/^<#\d+>$/.test(v)) return v; // channel (link only)
    // Try to coerce simple id or prefixed id
    const idMatch = v.match(/^@!?([0-9]{15,22})$/) || v.match(/^([0-9]{15,22})$/);
    if (idMatch) return `<@${idMatch[1]}>`;
    const chMatch = v.match(/^#([0-9]{15,22})$/);
    if (chMatch) return `<#${chMatch[1]}>`;
    return v; // leave as-is; may be a literal string
  };

  const analyzeMention = (val: string): { error: string | null; warnings: string[] } => {
    const v = (val || '').trim();
    if (!v) return { error: null, warnings: [] };
    if (v.length > 64) return { error: 'Mention exceeds 64 characters.', warnings: [] };
    const warnings: string[] = [];
    const isEveryone = v.toLowerCase() === '@everyone' || v.toLowerCase() === '@here';
    const isRole = /^<@&\d+>$/.test(v);
    const isUser = /^<@!?\d+>$/.test(v);
    const isChannel = /^<#\d+>$/.test(v);
    const isValid = isEveryone || isRole || isUser || isChannel;
    if (!isValid) {
      warnings.push('This may not ping. Use formats like @everyone, @here, <@USER_ID>, <@&ROLE_ID>, or <#CHANNEL_ID>.');
    }
    if (isEveryone) {
      warnings.push('Requires the "Mention @everyone, @here, and All Roles" permission for the bot in this channel.');
    }
    if (isRole) {
      warnings.push('If the role is not mentionable, the bot also needs the "Mention @everyone, @here, and All Roles" permission.');
    }
    if (isChannel) {
      warnings.push('Channel mentions create a link but do not ping.');
    }
    return { error: null, warnings };
  };

  // Sync form state with selected stream
  useEffect(() => {
    if (streams && selectedStreamId) {
      const stream = streams.find(s => s.id === selectedStreamId);
      if (stream) {
        const { days, time } = parseCron(stream.scheduleCron || undefined);
        setForm({
          streamName: stream.streamName,
          enabled: stream.enabled,
          timezone: stream.timezone || 'UTC',
          advancedCron: stream.scheduleCron || undefined,
          randomize: stream.randomize,
          autoApprove: stream.autoApprove,
          timeOfDay: time,
          daysOfWeek: days,
        });
        // Update the schedule builder UI
        setSchedules([
          { id: 1, days: new Set(days), time }
        ]);
      }
    }
  }, [streams, selectedStreamId]);

  // Listen for real-time QOTD updates via WebSocket
  useWebSocket((message) => {
    if (message.guildId !== guildId) return; // Ignore updates for other guilds

    if (message.type === 'QOTD_STREAM_CHANGED') {
      // Refresh streams for the affected channel
      if (message.channelId === selectedChannelId) {
        qc.invalidateQueries({ queryKey: ['qotd-streams', guildId, message.channelId] });
      }
      // Refresh stream summary indicators (enabled/configured badges)
      qc.invalidateQueries({
        predicate: (q) => Array.isArray(q.queryKey) && q.queryKey[0] === 'qotd-streams-summary' && q.queryKey[1] === guildId,
      });
    } else if (message.type === 'QOTD_QUESTIONS_CHANGED') {
      // Refresh questions for the affected stream
      if (message.channelId === selectedChannelId && message.streamId) {
        qc.invalidateQueries({ queryKey: ['qotd-stream-questions', guildId, message.channelId, message.streamId] });
      }
    } else if (message.type === 'QOTD_SUBMISSIONS_CHANGED') {
      // Refresh submissions list
      qc.invalidateQueries({ queryKey: ['qotd-submissions', guildId] });
    }
  });

  const updateStreamMutation = useMutation({
    mutationFn: (req: UpdateStreamRequest) => qotdApi.updateStream(guildId!, selectedChannelId!, selectedStreamId!, req),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ['qotd-streams', guildId, selectedChannelId] });
      qc.invalidateQueries({
        predicate: (q) => Array.isArray(q.queryKey) && q.queryKey[0] === 'qotd-streams-summary' && q.queryKey[1] === guildId,
      });
      setConfigMessage('âœ“ Saved stream configuration');
      setTimeout(() => setConfigMessage(''), 5000);
    },
    onError: (error: any) => {
      const errorMessage = error?.response?.data || 'Failed to save stream configuration';
      setConfigMessage(`âœ— ${errorMessage}`);
      setTimeout(() => setConfigMessage(''), 5000);
    },
  });

  const uploadCsvMutation = useMutation({
    mutationFn: (file: File) => qotdApi.uploadStreamCsv(guildId!, selectedChannelId!, selectedStreamId!, file),
    onSuccess: (res) => {
      const r = res.data;
      setQuestionMessage(`âœ“ Added ${r.successCount} questions${r.failureCount ? `, ${r.failureCount} failed` : ''}`);
      qc.invalidateQueries({ queryKey: ['qotd-stream-questions', guildId, selectedChannelId, selectedStreamId] });
      setCsvFile(null);
      setTimeout(() => setQuestionMessage(''), 5000);
    },
    onError: () => {
      setQuestionMessage('âœ— Failed to upload CSV');
      setTimeout(() => setQuestionMessage(''), 5000);
    },
  });

  const addQuestionMutation = useMutation({
    mutationFn: (text: string) => qotdApi.addStreamQuestion(guildId!, selectedChannelId!, selectedStreamId!, text),
    onSuccess: () => {
      setNewQuestion('');
      setQuestionMessage('âœ“ Question added');
      qc.invalidateQueries({ queryKey: ['qotd-stream-questions', guildId, selectedChannelId, selectedStreamId] });
      setTimeout(() => setQuestionMessage(''), 5000);
    },
    onError: () => {
      setQuestionMessage('âœ— Failed to add question');
      setTimeout(() => setQuestionMessage(''), 5000);
    },
  });

  const deleteQuestionMutation = useMutation({
    mutationFn: (id: number) => qotdApi.deleteStreamQuestion(guildId!, selectedChannelId!, selectedStreamId!, id),
    onSuccess: () => {
      setQuestionMessage('âœ“ Question deleted');
      qc.invalidateQueries({ queryKey: ['qotd-stream-questions', guildId, selectedChannelId, selectedStreamId] });
      setTimeout(() => setQuestionMessage(''), 5000);
    },
    onError: () => {
      setQuestionMessage('âœ— Failed to delete question');
      setTimeout(() => setQuestionMessage(''), 5000);
    },
  });

  const reorderQuestionsMutation = useMutation({
    mutationFn: (orderedIds: number[]) => qotdApi.reorderStreamQuestions(guildId!, selectedChannelId!, selectedStreamId!, orderedIds),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ['qotd-stream-questions', guildId, selectedChannelId, selectedStreamId] });
    },
    onError: () => {
      setQuestionMessage('âœ— Failed to reorder questions');
      setTimeout(() => setQuestionMessage(''), 5000);
    },
  });

  // Drag and drop state
  const [draggedIndex, setDraggedIndex] = useState<number | null>(null);
  const [dragOverIndex, setDragOverIndex] = useState<number | null>(null);

  const handleDragStart = (e: React.DragEvent, index: number) => {
    setDraggedIndex(index);
    e.dataTransfer.effectAllowed = 'move';
  };

  const handleDragOver = (e: React.DragEvent, index: number) => {
    e.preventDefault();
    if (draggedIndex !== null && draggedIndex !== index) {
      setDragOverIndex(index);
    }
  };

  const handleDragLeave = () => {
    setDragOverIndex(null);
  };

  const handleDrop = (e: React.DragEvent, dropIndex: number) => {
    e.preventDefault();
    
    if (draggedIndex === null || draggedIndex === dropIndex || !questions) return;
    
    // Create new array with reordered questions
    const reordered = [...questions];
    const [draggedItem] = reordered.splice(draggedIndex, 1);
    reordered.splice(dropIndex, 0, draggedItem);
    
    // Extract the new order of IDs
    const newOrder = reordered.map(q => q.id);
    
    // Call API to persist the new order
    reorderQuestionsMutation.mutate(newOrder);
    
    setDraggedIndex(null);
    setDragOverIndex(null);
  };

  const handleDragEnd = () => {
    setDraggedIndex(null);
    setDragOverIndex(null);
  };

  // Get channel name for display
  const getChannelName = (channelId: string) => {
    return channelNameMap.get(channelId) || channelId;
  };

  const expandAll = () => setExpandedNodes(new Set(allNodeIds));
  const collapseAll = () => setExpandedNodes(new Set());

  return (
    <div className="main-content">
      <nav className="server-nav">
        <div className="server-nav-container">
          <div className="server-nav-left">
            <button className="btn btn-link" onClick={() => navigate('/servers')}>â† Back to Servers</button>
          </div>
          <div className="server-nav-tabs">
            <button className="server-nav-tab" onClick={() => navigate(`/servers/${guildId}`)}>
              ğŸ¨ Gacha Config
            </button>
            <button className="server-nav-tab active">
              ğŸ’¬ QOTD Config
            </button>
          </div>
        </div>
      </nav>

      <div className="server-content">
        <div className="info-notice">
          <h3>Question of the Day - Per Channel</h3>
          <p>Configure separate question lists and schedules for each channel.</p>
        </div>

        {/* 2-Column Layout: Tree Sidebar (left) + Configuration (right) */}
        <div style={{
          display: 'grid',
          gridTemplateColumns: 'minmax(250px, 320px) 1fr',
          gap: '2rem',
          alignItems: 'start',
        }}>
          {/* LEFT SIDEBAR: Channel/Thread Tree */}
          <aside style={{ position: 'sticky', top: '1rem' }}>
            <section className="action-card">
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '0.5rem' }}>
                <h3 style={{ margin: 0 }}>Select Channel or Thread</h3>
                <div style={{ display: 'flex', gap: '0.5rem' }}>
                  <button className="btn btn-secondary btn-xs" onClick={expandAll}>Expand all</button>
                  <button className="btn btn-secondary btn-xs" onClick={collapseAll}>Collapse all</button>
                </div>
              </div>
              {channelTree && channelTree.length > 0 ? (
                <div style={{ padding: '0.75rem', maxHeight: '600px', overflowY: 'auto', border: '1px solid var(--border-color)', borderRadius: '4px' }}>
                  {channelTree.map((node) => (
                    <ChannelTreeNode
                      key={node.id}
                      node={node}
                      level={0}
                      expandedNodes={expandedNodes}
                      onToggleExpand={toggleExpandNode}
                      selectedChannelId={selectedChannelId}
                      onSelectChannel={(id) => {
                        setSelectedChannelId(id);
                        setSelectedStreamId(null); // Reset stream when changing channel
                      }}
                      configuredIds={configuredIds}
                      enabledIds={enabledIds}
                    />
                  ))}
                </div>
              ) : (
                <div style={{ color: '#666', fontStyle: 'italic', padding: '1rem' }}>Loading channels...</div>
              )}
            </section>
          </aside>

          {/* RIGHT MAIN: Configuration Sections */}
          <main>
            {/* Stream Selection (shown when channel is selected) */}
            {selectedChannelId && (
              <section className="action-card" style={{ marginBottom: '1rem' }}>
                <h3>Select Stream</h3>
                {streams ? (
                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                    {streams.map((stream) => (
                      <button
                        key={stream.id}
                        className={selectedStreamId === stream.id ? 'btn btn-primary btn-sm' : 'btn btn-secondary btn-sm'}
                        onClick={() => setSelectedStreamId(stream.id)}
                      >
                        {stream.streamName}
                        {stream.enabled && ' âœ“'}
                      </button>
                    ))}
                    {streams.length < 5 && (
                      <button
                        className="btn btn-success btn-sm"
                        onClick={() => setShowCreateStream(true)}
                      >
                        + New Stream
                      </button>
                    )}
                  </div>
                ) : (
                  <div>Loading streams...</div>
                )}
              </section>
            )}

        {/* Create Stream Dialog */}
        {showCreateStream && (
          <div className="modal-overlay" onClick={() => setShowCreateStream(false)}>
            <div className="modal" onClick={(e) => e.stopPropagation()}>
              <h3>Create New Stream</h3>
              <div style={{ marginTop: '1rem' }}>
                <label>Stream Name:</label>
                <input
                  type="text"
                  className="input"
                  placeholder="e.g., Weekly QOTD, Fun Facts"
                  value={newStreamName}
                  onChange={(e) => setNewStreamName(e.target.value)}
                  maxLength={64}
                  style={{ width: '100%', marginTop: '0.5rem' }}
                />
              </div>
              <div style={{ display: 'flex', gap: '0.5rem', marginTop: '1.5rem' }}>
                <button
                  className="btn btn-primary"
                  onClick={async () => {
                    if (!newStreamName.trim() || !guildId || !selectedChannelId) return;
                    try {
                      const request: CreateStreamRequest = {
                        streamName: newStreamName.trim(),
                        enabled: false,
                        timezone: 'UTC',
                        randomize: false,
                        autoApprove: false,
                        daysOfWeek: ['MON', 'TUE', 'WED', 'THU', 'FRI'],
                        timeOfDay: '09:00',
                      };
                      const result = await qotdApi.createStream(guildId, selectedChannelId, request);
                      qc.invalidateQueries({ queryKey: ['qotd-streams', guildId, selectedChannelId] });
                      setSelectedStreamId(result.data.id);
                      setShowCreateStream(false);
                      setNewStreamName('');
                      setConfigMessage('âœ“ Stream created successfully');
                      setTimeout(() => setConfigMessage(''), 5000);
                    } catch (err: any) {
                      const msg = err?.response?.data || 'Failed to create stream';
                      setConfigMessage(`âœ— ${msg}`);
                      setTimeout(() => setConfigMessage(''), 5000);
                    }
                  }}
                  disabled={!newStreamName.trim()}
                >
                  Create
                </button>
                <button
                  className="btn btn-secondary"
                  onClick={() => {
                    setShowCreateStream(false);
                    setNewStreamName('');
                  }}
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        )}

            {/* Show stream config only when stream is selected */}
            {selectedChannelId && selectedStreamId && (
              <>
            <section className="action-card" style={{ marginBottom: '1rem' }}>
              <h3>QOTD Banner for {getChannelName(selectedChannelId)}</h3>
              {bannerLoading ? (
                <div>Loading banner...</div>
              ) : bannerEdit ? (
                <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', flexWrap: 'wrap' }}>
                  {/* Formatting toolbar */}
                  <div style={{ display: 'flex', gap: '0.25rem', alignItems: 'center', position: 'relative' }}>
                    <span style={{ fontSize: '0.9rem', color: '#666' }}>Format:</span>
                    <button className="btn btn-sm" title="Bold" aria-label="Bold" onClick={() => applyFormat('**')}>B</button>
                    <button className="btn btn-sm" title="Italic" aria-label="Italic" onClick={() => applyFormat('*')}>I</button>
                    <button className="btn btn-sm" title="Underline" aria-label="Underline" onClick={() => applyFormat('__')}>U</button>
                    <button className="btn btn-sm" title="Strikethrough" aria-label="Strikethrough" onClick={() => applyFormat('~~')}>S</button>
                    <button 
                      className="btn btn-sm" 
                      title="Emoji picker" 
                      aria-label="Open emoji picker"
                      onClick={() => {
                        setShowEmojiPicker(v => !v);
                        if (!showEmojiPicker) setSelectedEmojiIndex(0);
                      }}
                    >
                      ğŸ˜€ Emojis
                    </button>
                    {showEmojiPicker && (
                      <div ref={emojiPickerRef} className="emoji-picker" role="listbox" aria-label="Emoji picker">
                        {/* Search bar */}
                        <div style={{ marginBottom: '0.5rem' }}>
                          <input
                            type="text"
                            className="input"
                            placeholder="Search emojis... (e.g., 'heart', 'smile', 'fire')"
                            value={emojiSearchQuery}
                            onChange={(e) => {
                              setEmojiSearchQuery(e.target.value);
                              setSelectedEmojiIndex(0);
                            }}
                            onKeyDown={(e) => {
                              if (e.key === 'Escape') {
                                e.stopPropagation();
                                if (emojiSearchQuery) {
                                  setEmojiSearchQuery('');
                                } else {
                                  setShowEmojiPicker(false);
                                  bannerInputRef.current?.focus();
                                }
                              }
                            }}
                            style={{ fontSize: '0.85rem', padding: '0.4rem 0.6rem' }}
                          />
                        </div>
                        
                        {/* Category tabs (hidden when searching) */}
                        {!emojiSearchQuery && (
                          <div style={{ display: 'flex', gap: '4px', marginBottom: '0.5rem', overflowX: 'auto', borderBottom: '1px solid var(--border)', paddingBottom: '0.25rem' }}>
                            {Object.keys(EMOJI_CATEGORIES).map((cat) => (
                              <button
                                key={cat}
                                className={`btn btn-sm ${selectedCategory === cat ? 'btn-primary' : 'btn-secondary'}`}
                                style={{ fontSize: '0.75rem', padding: '4px 8px', whiteSpace: 'nowrap' }}
                                onClick={() => {
                                  setSelectedCategory(cat);
                                  setSelectedEmojiIndex(0);
                                }}
                              >
                                {cat}
                              </button>
                            ))}
                          </div>
                        )}
                        
                        {/* Recent emojis row (if any, only when not searching and on Smileys) */}
                        {!emojiSearchQuery && recentEmojis.length > 0 && selectedCategory === 'Smileys' && (
                          <>
                            <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginBottom: '0.25rem', paddingLeft: '4px' }}>
                              Recent
                            </div>
                            <div className="emoji-grid" style={{ marginBottom: '0.5rem', gridTemplateColumns: `repeat(${Math.min(recentEmojis.length, 10)}, 38px)`, maxHeight: 'none' }}>
                              {recentEmojis.map((e, idx) => (
                                <button 
                                  key={`recent-${e}-${idx}`} 
                                  className={`emoji-btn ${idx === selectedEmojiIndex ? 'selected' : ''}`}
                                  role="option"
                                  aria-label={`Recent emoji: ${e}`}
                                  aria-selected={idx === selectedEmojiIndex}
                                  onClick={(ev) => insertEmoji(e, ev.shiftKey)}
                                >
                                  {e}
                                </button>
                              ))}
                            </div>
                          </>
                        )}
                        
                        {/* Emojis (filtered or category) */}
                        <div className="emoji-grid">
                          {(() => {
                            const emojis = getFilteredEmojis();
                            const startIdx = emojiSearchQuery ? 0 : (selectedCategory === 'Smileys' && recentEmojis.length > 0 ? recentEmojis.length : 0);
                            
                            if (emojis.length === 0) {
                              return (
                                <div style={{ gridColumn: '1 / -1', textAlign: 'center', padding: '1rem', color: 'var(--text-secondary)' }}>
                                  No emojis found for "{emojiSearchQuery}"
                                </div>
                              );
                            }
                            
                            return emojis.map((e, idx) => {
                              const globalIdx = startIdx + idx;
                              const hasVariations = emojiVariations[e] && emojiVariations[e].length > 1;
                              return (
                                <button 
                                  key={`${emojiSearchQuery ? 'search' : selectedCategory}-${e}-${idx}`} 
                                  className={`emoji-btn ${globalIdx === selectedEmojiIndex ? 'selected' : ''} ${hasVariations ? 'has-variations' : ''}`}
                                  role="option"
                                  aria-label={`${emojiSearchQuery ? 'Search result' : selectedCategory} emoji: ${e}`}
                                  aria-selected={globalIdx === selectedEmojiIndex}
                                  onClick={(ev) => handleEmojiClick(e, ev.shiftKey)}
                                  onMouseDown={(ev) => handleEmojiMouseDown(e, ev)}
                                  onMouseUp={handleEmojiMouseUp}
                                  onMouseLeave={handleEmojiMouseUp}
                                  onTouchStart={(ev) => handleEmojiMouseDown(e, ev as any)}
                                  onTouchEnd={handleEmojiMouseUp}
                                  onTouchCancel={handleEmojiMouseUp}
                                  title={emojiKeywords[e] || (hasVariations ? 'Hold for variations' : '')}
                                >
                                  {e}
                                  {hasVariations && <span className="variation-indicator">âŠ•</span>}
                                </button>
                              );
                            });
                          })()}
                        </div>
                        
                        <div className="emoji-tip">
                          {emojiSearchQuery ? (
                            <>ğŸ’¡ Type to search â€¢ <kbd>Esc</kbd> to clear</>
                          ) : (
                            <><kbd>â†‘â†“â†â†’</kbd> navigate â€¢ <kbd>Enter</kbd> insert â€¢ <kbd>Shift+Click</kbd> keep open â€¢ <kbd>Esc</kbd> close â€¢ Hold for variations</>
                          )}
                        </div>
                        
                        {/* Emoji variations popup */}
                        {showVariations && (
                          <div 
                            className="emoji-variations-popup"
                            style={{
                              position: 'fixed',
                              left: showVariations.x,
                              top: showVariations.y,
                              zIndex: 101
                            }}
                          >
                            {emojiVariations[showVariations.emoji]?.map((variant, idx) => (
                              <button
                                key={`variant-${variant}-${idx}`}
                                className="emoji-btn"
                                onClick={() => insertEmoji(variant, false)}
                                title={variant}
                              >
                                {variant}
                              </button>
                            ))}
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                  <div style={{ position: 'relative', flex: 1 }}>
                    <input
                      className="input"
                      ref={bannerInputRef}
                      value={banner}
                      onChange={e => setBanner(e.target.value)}
                      onKeyDown={(e) => {
                        if (e.key === 'Escape') {
                          e.preventDefault();
                          setBanner(originalBanner);
                          setEmbedColor(originalEmbedColor);
                          setBannerEdit(false);
                        } else if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                          e.preventDefault();
                          const saveBtn = e.currentTarget.parentElement?.parentElement?.querySelector('.btn-primary') as HTMLButtonElement;
                          saveBtn?.click();
                        }
                      }}
                      placeholder="Enter banner text (Unicode/emojis supported)"
                      maxLength={160}
                      style={{ flex: 1, fontSize: '1.1rem', paddingRight: '60px' }}
                    />
                    <span style={{
                      position: 'absolute',
                      right: '0.75rem',
                      top: '50%',
                      transform: 'translateY(-50%)',
                      fontSize: '0.8rem',
                      color: banner.length > 150 ? '#d97706' : banner.length > 140 ? '#f59e0b' : 'var(--text-secondary)',
                      fontWeight: banner.length > 140 ? 600 : 400,
                      pointerEvents: 'none'
                    }}>
                      {banner.length}/160
                    </span>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                    <label className="field-label" style={{ margin: 0 }}>Embed color</label>
                    <input
                      type="color"
                      value={toHexColor(embedColor ?? 0x9B59B6)}
                      onChange={(e) => setEmbedColor(parseInt(e.target.value.replace('#',''), 16))}
                      title="#RRGGBB"
                      aria-label="Embed accent color"
                      style={{ width: 40, height: 32, padding: 0, border: '1px solid var(--border-color)', borderRadius: 4 }}
                    />
                    <input
                      type="text"
                      className="input"
                      value={toHexColor(embedColor ?? 0x9B59B6)}
                      onChange={(e) => {
                        const hex = e.target.value.trim();
                        if (/^#?[0-9A-Fa-f]{0,6}$/.test(hex)) {
                          const clean = hex.replace('#', '');
                          if (clean.length === 6) {
                            setEmbedColor(parseInt(clean, 16));
                          }
                        }
                      }}
                      placeholder="#RRGGBB"
                      aria-label="Embed color hex code"
                      style={{ width: '90px', fontSize: '0.85rem', fontFamily: 'monospace' }}
                    />
                  </div>
                  <button 
                    className="btn btn-primary btn-sm" 
                    disabled={bannerSaving || (banner === originalBanner && embedColor === originalEmbedColor)}
                    onClick={async () => {
                      setBannerSaving(true);
                      try {
                        await qotdApi.setStreamBanner(guildId!, selectedChannelId, selectedStreamId!, banner);
                        if (embedColor != null) await qotdApi.setStreamBannerColor(guildId!, selectedChannelId, selectedStreamId!, embedColor);
                        setOriginalBanner(banner);
                        setOriginalEmbedColor(embedColor);
                        setBannerMessage('âœ“ Banner saved');
                        setBannerEdit(false);
                        setTimeout(() => setBannerMessage(''), 4000);
                      } catch (err: any) {
                        const msg = err?.response?.data || 'Failed to save banner';
                        setBannerMessage(`âœ— ${msg}`);
                        setTimeout(() => setBannerMessage(''), 6000);
                      } finally {
                        setBannerSaving(false);
                      }
                    }}
                  >
                    {bannerSaving ? 'â³ Saving...' : 'Save'}
                  </button>
                  <button className="btn btn-secondary btn-sm" onClick={() => {
                    setBanner(originalBanner);
                    setEmbedColor(originalEmbedColor);
                    setBannerEdit(false);
                  }}>Cancel</button>
                  <button className="btn btn-danger btn-sm" onClick={async () => {
                    try {
                      await qotdApi.resetStreamBanner(guildId!, selectedChannelId, selectedStreamId!);
                      setBanner('â“â“ Question of the Day â“â“');
                      setEmbedColor(0x9B59B6);
                      setBannerMessage('âœ“ Banner reset to default');
                      setBannerEdit(false);
                      setTimeout(() => setBannerMessage(''), 4000);
                    } catch {
                      setBannerMessage('âœ— Failed to reset banner');
                      setTimeout(() => setBannerMessage(''), 4000);
                    }
                  }}>Reset to Default</button>
                </div>
              ) : (
                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                  <div className="banner-display" style={{ borderLeft: `6px solid ${toHexColor(embedColor ?? 0x9B59B6)}` }}>
                    {banner}
                  </div>
                  <button className="btn btn-secondary btn-sm" onClick={() => setBannerEdit(true)}>Edit Banner</button>
                </div>
              )}
              {bannerMessage && (
                <div className={`upload-message-inline ${bannerMessage.startsWith('âœ“') ? 'success' : 'error'}`} style={{ marginTop: '0.5rem' }}>{bannerMessage}</div>
              )}
              {bannerEdit && (
                <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginTop: '0.5rem', paddingLeft: '4px' }}>
                  ğŸ’¡ Tip: <kbd>Esc</kbd> to cancel â€¢ <kbd>Cmd+Enter</kbd> to save
                </div>
              )}
            </section>
            <section className="action-card" style={{ marginBottom: '1rem' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                <h3 style={{ margin: 0 }}>
                  Configuration: {streams?.find(s => s.id === selectedStreamId)?.streamName || 'Stream'}
                </h3>
                {streams && streams.length > 1 && (
                  <button
                    className="btn btn-danger btn-sm"
                    onClick={async () => {
                      const stream = streams.find(s => s.id === selectedStreamId);
                      const questionCount = questions?.length || 0;
                      const confirmed = window.confirm(
                        `Delete stream "${stream?.streamName}"?\n\n` +
                        `This will permanently delete ${questionCount} question(s) in this stream.\n\n` +
                        `This action cannot be undone.`
                      );
                      if (confirmed && guildId && selectedChannelId && selectedStreamId) {
                        try {
                          await qotdApi.deleteStream(guildId, selectedChannelId, selectedStreamId);
                          qc.invalidateQueries({ queryKey: ['qotd-streams', guildId, selectedChannelId] });
                          // Select the first remaining stream
                          const remaining = streams.filter(s => s.id !== selectedStreamId);
                          if (remaining.length > 0) {
                            setSelectedStreamId(remaining[0].id);
                          } else {
                            setSelectedStreamId(null);
                          }
                          setConfigMessage('âœ“ Stream deleted successfully');
                          setTimeout(() => setConfigMessage(''), 5000);
                        } catch (err: any) {
                          const msg = err?.response?.data || 'Failed to delete stream';
                          setConfigMessage(`âœ— ${msg}`);
                          setTimeout(() => setConfigMessage(''), 5000);
                        }
                      }
                    }}
                    title="Delete this stream"
                  >
                    Delete Stream
                  </button>
                )}
              </div>
              {/* Queue status */}
              <div style={{ marginBottom: '0.5rem', display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                {(() => {
                  const remaining = questions?.length ?? 0;
                  if (remaining === 0) {
                    return (
                      <span style={{
                        background: '#ffe6e6', color: '#a80000', padding: '4px 8px', borderRadius: 4,
                        border: '1px solid #ffb3b3', fontSize: '0.85rem'
                      }}>
                        â— No questions remaining â€” posting will pause until you add more.
                      </span>
                    );
                  }
                  if (remaining <= 3) {
                    return (
                      <span style={{
                        background: '#fff7e6', color: '#8a6100', padding: '4px 8px', borderRadius: 4,
                        border: '1px solid #ffe0a3', fontSize: '0.85rem'
                      }}>
                        âš  Only {remaining} question{remaining === 1 ? '' : 's'} left in the queue.
                      </span>
                    );
                  }
                  return (
                    <span style={{
                      background: '#eef7ff', color: '#0b61a4', padding: '4px 8px', borderRadius: 4,
                      border: '1px solid #cfe7ff', fontSize: '0.85rem'
                    }}>
                      Queue: {remaining} remaining
                    </span>
                  );
                })()}
              </div>
              <div className="add-role-form">
                <div className="form-row">
                  <div className="field">
                    <label className="field-label">
                      Stream Name
                      <span style={{ fontSize: '0.85rem', color: '#999', fontWeight: 'normal', marginLeft: '0.5rem' }}>
                        (max 64 characters)
                      </span>
                    </label>
                    <input
                      className="input"
                      type="text"
                      value={form.streamName || ''}
                      onChange={e => setForm({ ...form, streamName: e.target.value })}
                      placeholder="e.g., Weekly QOTD, Daily Trivia"
                      maxLength={64}
                    />
                  </div>
                </div>
                <div className="form-row">
                  <div className="field">
                    <label className="field-label">
                      Mention Target
                      <span style={{ fontSize: '0.85rem', color: '#999', fontWeight: 'normal', marginLeft: '0.5rem' }}>
                        (@user, @role, @channel, or leave blank)
                      </span>
                    </label>
                    <input
                      className="input"
                      type="text"
                      value={mentionTarget}
                      onChange={e => {
                        const val = e.target.value;
                        setMentionTarget(val);
                        const { error, warnings } = analyzeMention(val);
                        setMentionError(error);
                        setMentionWarnings(warnings);
                      }}
                      onBlur={() => {
                        const normalized = normalizeMention(mentionTarget);
                        setMentionTarget(normalized);
                        const { error, warnings } = analyzeMention(normalized);
                        setMentionError(error);
                        setMentionWarnings(warnings);
                      }}
                      placeholder="e.g. @everyone, @admins, @general, @1234567890"
                      maxLength={64}
                      style={{ width: '220px' }}
                    />
                  </div>
                  <div className="field">
                    <label className="field-label">Enabled</label>
                    <input type="checkbox" checked={form.enabled} onChange={(e) => setForm({ ...form, enabled: e.target.checked })} />
                  </div>
                  <div className="field">
                    <label className="field-label">Randomize order</label>
                    <input type="checkbox" checked={form.randomize} onChange={(e) => setForm({ ...form, randomize: e.target.checked })} />
                  </div>
                  <div className="field">
                    <label className="field-label">
                      Auto-approve submissions
                      <span style={{ fontSize: '0.85rem', color: '#999', fontWeight: 'normal', marginLeft: '0.5rem' }}>
                        (submissions instantly added to queue)
                      </span>
                    </label>
                    <input type="checkbox" checked={form.autoApprove} onChange={(e) => setForm({ ...form, autoApprove: e.target.checked })} />
                  </div>
                </div>
                {(mentionError || mentionWarnings.length > 0) && (
                  <div style={{ marginTop: '0.35rem' }}>
                    {mentionError ? (
                      <div className="upload-message-inline error">{mentionError}</div>
                    ) : (
                      <ul style={{ color: 'var(--text-secondary)', fontSize: '0.85rem', paddingLeft: '1rem', margin: 0 }}>
                        {mentionWarnings.map((w, i) => (
                          <li key={i}>{w}</li>
                        ))}
                      </ul>
                    )}
                  </div>
                )}
                <div className="form-row">
                  <div className="field">
                    <label className="field-label">Timezone</label>
                    <select 
                      className="input" 
                      value={form.timezone} 
                      onChange={(e) => setForm({ ...form, timezone: e.target.value })}
                    >
                      <optgroup label="US & Canada">
                        <option value="America/New_York">Eastern Time (ET)</option>
                        <option value="America/Chicago">Central Time (CT)</option>
                        <option value="America/Denver">Mountain Time (MT)</option>
                        <option value="America/Phoenix">Arizona (MST)</option>
                        <option value="America/Los_Angeles">Pacific Time (PT)</option>
                        <option value="America/Anchorage">Alaska (AKT)</option>
                        <option value="Pacific/Honolulu">Hawaii (HST)</option>
                      </optgroup>
                      <optgroup label="Europe">
                        <option value="Europe/London">London (GMT/BST)</option>
                        <option value="Europe/Paris">Paris (CET/CEST)</option>
                        <option value="Europe/Berlin">Berlin (CET/CEST)</option>
                        <option value="Europe/Rome">Rome (CET/CEST)</option>
                        <option value="Europe/Madrid">Madrid (CET/CEST)</option>
                        <option value="Europe/Amsterdam">Amsterdam (CET/CEST)</option>
                        <option value="Europe/Brussels">Brussels (CET/CEST)</option>
                        <option value="Europe/Vienna">Vienna (CET/CEST)</option>
                        <option value="Europe/Stockholm">Stockholm (CET/CEST)</option>
                        <option value="Europe/Athens">Athens (EET/EEST)</option>
                        <option value="Europe/Moscow">Moscow (MSK)</option>
                      </optgroup>
                      <optgroup label="Asia & Pacific">
                        <option value="Asia/Dubai">Dubai (GST)</option>
                        <option value="Asia/Kolkata">India (IST)</option>
                        <option value="Asia/Shanghai">China (CST)</option>
                        <option value="Asia/Hong_Kong">Hong Kong (HKT)</option>
                        <option value="Asia/Singapore">Singapore (SGT)</option>
                        <option value="Asia/Tokyo">Tokyo (JST)</option>
                        <option value="Asia/Seoul">Seoul (KST)</option>
                        <option value="Australia/Sydney">Sydney (AEDT/AEST)</option>
                        <option value="Australia/Melbourne">Melbourne (AEDT/AEST)</option>
                        <option value="Pacific/Auckland">Auckland (NZDT/NZST)</option>
                      </optgroup>
                      <optgroup label="Americas">
                        <option value="America/Toronto">Toronto (ET)</option>
                        <option value="America/Vancouver">Vancouver (PT)</option>
                        <option value="America/Mexico_City">Mexico City (CST)</option>
                        <option value="America/Sao_Paulo">SÃ£o Paulo (BRT)</option>
                        <option value="America/Buenos_Aires">Buenos Aires (ART)</option>
                      </optgroup>
                      <optgroup label="Other">
                        <option value="UTC">UTC</option>
                        <option value="Africa/Cairo">Cairo (EET)</option>
                        <option value="Africa/Johannesburg">Johannesburg (SAST)</option>
                      </optgroup>
                    </select>
                  </div>
                </div>

                {/* Schedule Builder - same as before */}
                <div style={{ marginTop: '1rem' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                    <label className="field-label">Schedules</label>
                    <button 
                      className="btn btn-link" 
                      onClick={() => setShowAdvanced(!showAdvanced)}
                      style={{ fontSize: '0.85rem' }}
                    >
                      {showAdvanced ? 'â† Simple Mode' : 'Advanced (cron) â†’'}
                    </button>
                  </div>

                  {!showAdvanced ? (
                    <>
                      {schedules.map((sched, idx) => (
                        <div key={sched.id} className="schedule-row" style={{ 
                          display: 'flex', 
                          alignItems: 'center', 
                          gap: '0.75rem', 
                          marginBottom: '0.75rem',
                          padding: '0.75rem',
                          background: 'var(--card-bg)',
                          borderRadius: '6px',
                          border: '1px solid var(--border-color)'
                        }}>
                          <div style={{ flex: 1 }}>
                            <div style={{ fontSize: '0.85rem', color: '#999', marginBottom: '0.25rem' }}>Days</div>
                            <div style={{ display: 'flex', gap: '0.25rem', flexWrap: 'wrap' }}>
                              {['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'].map((day) => (
                                <button
                                  key={day}
                                  className={sched.days.has(day) ? 'btn btn-primary btn-sm' : 'btn btn-secondary btn-sm'}
                                  onClick={() => {
                                    const newSchedules = [...schedules];
                                    const newDays = new Set(newSchedules[idx].days);
                                    if (newDays.has(day)) {
                                      newDays.delete(day);
                                    } else {
                                      newDays.add(day);
                                    }
                                    newSchedules[idx] = { ...newSchedules[idx], days: newDays };
                                    setSchedules(newSchedules);
                                  }}
                                  style={{ minWidth: '42px', padding: '0.25rem 0.5rem' }}
                                >
                                  {day.substring(0, 1)}
                                </button>
                              ))}
                            </div>
                          </div>
                          <div style={{ minWidth: '110px' }}>
                            <div style={{ fontSize: '0.85rem', color: '#999', marginBottom: '0.25rem' }}>Time</div>
                            <input
                              type="time"
                              className="input"
                              value={sched.time}
                              onChange={(e) => {
                                const newSchedules = [...schedules];
                                newSchedules[idx] = { ...newSchedules[idx], time: e.target.value };
                                setSchedules(newSchedules);
                              }}
                              style={{ fontSize: '0.9rem' }}
                            />
                          </div>
                          <button
                            className="btn btn-danger btn-sm"
                            onClick={() => setSchedules(schedules.filter((_, i) => i !== idx))}
                            disabled={schedules.length === 1}
                            style={{ marginTop: '1.2rem' }}
                          >
                            âœ•
                          </button>
                        </div>
                      ))}
                      <button
                        className="btn btn-secondary btn-sm"
                        onClick={() => {
                          const newId = Math.max(...schedules.map(s => s.id), 0) + 1;
                          setSchedules([...schedules, { id: newId, days: new Set(['MON']), time: '09:00' }]);
                        }}
                        style={{ marginTop: '0.5rem' }}
                      >
                        + Add Schedule
                      </button>
                    </>
                  ) : (
                    <div className="field" style={{ minWidth: 260 }}>
                      <label className="field-label">Advanced (cron)</label>
                      <input 
                        className="input" 
                        placeholder="e.g., 0 0 9 ? * MON-FRI" 
                        value={form.advancedCron || ''} 
                        onChange={(e) => setForm({ ...form, advancedCron: e.target.value })} 
                      />
                    </div>
                  )}
                </div>

                <div className="form-actions">
                  <button className="btn btn-primary btn-sm" onClick={async () => {
                    // Validate/normalize mention first
                    const normalized = normalizeMention(mentionTarget);
                    setMentionTarget(normalized);
                    const analysis = analyzeMention(normalized);
                    setMentionError(analysis.error);
                    setMentionWarnings(analysis.warnings);
                    if (analysis.error) {
                      setConfigMessage(`âœ— ${analysis.error}`);
                      setTimeout(() => setConfigMessage(''), 6000);
                      return;
                    }
                    // Persist mention using its dedicated endpoint
                    if (guildId && selectedChannelId && selectedStreamId) {
                      try {
                        await qotdApi.setStreamBannerMention(guildId, selectedChannelId, selectedStreamId, normalized);
                      } catch (e: any) {
                        const msg = e?.response?.data || 'Failed to save mention';
                        setConfigMessage(`âœ— ${msg}`);
                        setTimeout(() => setConfigMessage(''), 6000);
                        return; // don't proceed if mention save failed
                      }
                    }
                    const requestData: UpdateStreamRequest = {
                      streamName: streams?.find(s => s.id === selectedStreamId)?.streamName || 'Default',
                      enabled: form.enabled,
                      timezone: form.timezone,
                      randomize: form.randomize,
                      autoApprove: form.autoApprove,
                    };
                    if (!showAdvanced && schedules.length > 0) {
                      const allDays = new Set<string>();
                      const times = new Set<string>();
                      schedules.forEach(sched => {
                        if (sched.days.size > 0) {
                          sched.days.forEach(day => allDays.add(day));
                          times.add(sched.time);
                        }
                      });
                      const firstTime = schedules[0]?.time || '09:00';
                      requestData.daysOfWeek = Array.from(allDays);
                      requestData.timeOfDay = firstTime;
                      requestData.advancedCron = null;
                      if (times.size > 1) {
                        setConfigMessage(`âš  Multiple times detected. Using ${firstTime}. Days are combined. Use Advanced mode for different times.`);
                        setTimeout(() => setConfigMessage(''), 8000);
                      }
                    } else {
                      requestData.advancedCron = form.advancedCron || null;
                    }
                    updateStreamMutation.mutate(requestData);
                  }}>Save</button>
                  <button
                    className="btn btn-secondary btn-sm"
                    disabled={!form.enabled}
                    title={!form.enabled ? 'Enable QOTD for this channel to use Post Now' : ''}
                    style={!form.enabled ? { opacity: 0.6, cursor: 'not-allowed' } : {}}
                    onClick={async () => {
                      if (!guildId || !selectedChannelId || !selectedStreamId || !form.enabled) return;
                      try {
                        await qotdApi.postStreamNow(guildId, selectedChannelId, selectedStreamId);
                        setConfigMessage('âœ“ Posted next question');
                        qc.invalidateQueries({ queryKey: ['qotd-stream-questions', guildId, selectedChannelId, selectedStreamId] });
                        setTimeout(() => setConfigMessage(''), 5000);
                      } catch {
                        setConfigMessage('âœ— Failed to post (queue empty or permissions)');
                        setTimeout(() => setConfigMessage(''), 5000);
                      }
                    }}
                  >
                    Post Now
                  </button>
                  {!form.enabled && (
                    <div style={{ color: '#a80000', fontSize: '0.95em', marginTop: 4 }}>
                      Enable QOTD for this channel to test posting.
                    </div>
                  )}
                  <button className="btn btn-secondary btn-sm" onClick={() => {
                    const clearedForm = { ...form, enabled: false, advancedCron: '', daysOfWeek: [], timeOfDay: '' };
                    setForm(clearedForm);
                    setSchedules([{ id: 1, days: new Set(['MON', 'TUE', 'WED', 'THU', 'FRI']), time: '09:00' }]);
                    const clearRequest: UpdateStreamRequest = {
                      streamName: streams?.find(s => s.id === selectedStreamId)?.streamName || 'Default',
                      enabled: false,
                      timezone: clearedForm.timezone,
                      randomize: clearedForm.randomize,
                      autoApprove: clearedForm.autoApprove,
                      advancedCron: '',
                      daysOfWeek: [],
                      timeOfDay: '',
                    };
                    updateStreamMutation.mutate(clearRequest);
                  }}>Clear Schedule</button>
                  {config?.nextRuns?.length && (form.enabled && (form.advancedCron || schedules.some(s => s.days.size > 0))) ? (
                    <span className="selection-count">Next runs: {config.nextRuns.slice(0,3).join(', ')}</span>
                  ) : null}
                </div>
                {configMessage && (
                  <div className={`upload-message-inline ${configMessage.startsWith('âœ“') ? 'success' : 'error'}`}>{configMessage}</div>
                )}
              </div>
            </section>

            {/* Questions section for selected channel */}
            <section className="action-card">
              <div style={{ marginBottom: '1.5rem' }}>
                <h3 style={{ marginBottom: '0.5rem' }}>Questions for #{getChannelName(selectedChannelId)}</h3>
                <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', flexWrap: 'wrap' }}>
                  <span style={{ 
                    background: questions?.length === 0 ? '#ffe6e6' : questions?.length && questions.length <= 3 ? '#fff7e6' : '#eef7ff',
                    color: questions?.length === 0 ? '#a80000' : questions?.length && questions.length <= 3 ? '#8a6100' : '#0b61a4',
                    padding: '6px 12px', 
                    borderRadius: '6px',
                    border: `1px solid ${questions?.length === 0 ? '#ffb3b3' : questions?.length && questions.length <= 3 ? '#ffe0a3' : '#cfe7ff'}`,
                    fontSize: '0.9rem',
                    fontWeight: 500
                  }}>
                    {questions?.length === 0 ? 'â— ' : questions?.length && questions.length <= 3 ? 'âš  ' : 'ğŸ“‹ '}
                    {questions?.length || 0} question{questions?.length === 1 ? '' : 's'}
                  </span>
                  {questions?.length === 0 && (
                    <span style={{ fontSize: '0.9rem', color: '#a80000' }}>
                      Empty queue â€” add questions or upload a CSV
                    </span>
                  )}
                  {questions && questions.length > 0 && questions.length <= 3 && (
                    <span style={{ fontSize: '0.9rem', color: '#8a6100' }}>
                      Low queue â€” consider adding more
                    </span>
                  )}
                </div>
              </div>
              
              <div className="add-role-form">
                {/* Add question input */}
                <div style={{ marginBottom: '1.5rem' }}>
                  <label className="field-label" style={{ marginBottom: '0.5rem', display: 'block' }}>Add Single Question</label>
                  <div className="form-row" style={{ gap: '0.75rem' }}>
                    <input
                      className="input"
                      placeholder="Enter a question..."
                      value={newQuestion}
                      onChange={(e) => setNewQuestion(e.target.value)}
                      onKeyDown={(e) => { if (e.key === 'Enter' && newQuestion.trim()) addQuestionMutation.mutate(newQuestion); }}
                      style={{ flex: 1 }}
                    />
                    <button 
                      className="btn btn-primary btn-sm" 
                      onClick={() => addQuestionMutation.mutate(newQuestion)} 
                      disabled={!newQuestion.trim()}
                      style={{ minWidth: '120px' }}
                    >
                      Add Question
                    </button>
                  </div>
                </div>

                {/* CSV Upload */}
                <div style={{ marginBottom: '1.5rem' }}>
                  <label className="field-label" style={{ marginBottom: '0.5rem', display: 'block' }}>Bulk Upload from CSV</label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', flexWrap: 'wrap' }}>
                    <a
                      href={guildId ? `/api/servers/${guildId}/qotd/download-example` : '#'}
                      className="btn btn-secondary btn-sm"
                      download
                      style={{ textDecoration: 'none' }}
                    >
                      ğŸ“¥ Download Example CSV
                    </a>
                    <div style={{ 
                      flex: 1, 
                      minWidth: '250px',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.75rem',
                      padding: '0.75rem',
                      background: 'var(--card-bg)',
                      border: '2px dashed var(--border-color)',
                      borderRadius: '8px'
                    }}>
                      <label htmlFor="csv-upload" style={{ 
                        flex: 1,
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem'
                      }}>
                        <span style={{ fontSize: '1.2rem' }}>ğŸ“„</span>
                        <span style={{ fontSize: '0.9rem', color: csvFile ? 'var(--text-color)' : '#999' }}>
                          {csvFile ? csvFile.name : 'Choose a CSV file...'}
                        </span>
                      </label>
                      <input 
                        id="csv-upload"
                        type="file" 
                        accept=".csv" 
                        onChange={(e) => setCsvFile(e.target.files?.[0] || null)}
                        style={{ display: 'none' }}
                      />
                      {csvFile && (
                        <button 
                          className="btn btn-sm"
                          onClick={() => setCsvFile(null)}
                          style={{ padding: '0.25rem 0.5rem', fontSize: '0.85rem' }}
                        >
                          âœ•
                        </button>
                      )}
                    </div>
                    <button 
                      className="btn btn-primary btn-sm" 
                      onClick={() => { if (csvFile) uploadCsvMutation.mutate(csvFile); }} 
                      disabled={!csvFile}
                      style={{ minWidth: '100px' }}
                    >
                      ğŸ“¤ Upload CSV
                    </button>
                  </div>
                </div>

                {questionMessage && (
                  <div className={`upload-message-inline ${questionMessage.startsWith('âœ“') ? 'success' : 'error'}`} style={{ marginBottom: '1rem' }}>
                    {questionMessage}
                  </div>
                )}

                {/* Questions List */}
                {questions && questions.length > 0 && (
                  <div>
                    <label className="field-label" style={{ marginBottom: '0.75rem', display: 'block' }}>
                      Question Queue
                      <span style={{ fontSize: '0.85rem', color: '#999', fontWeight: 'normal', marginLeft: '0.5rem' }}>
                        (drag to reorder)
                      </span>
                    </label>
                    <div className="role-list" style={{ gap: '0.75rem' }}>
                      {questions.map((q, index) => (
                        <div 
                          key={q.id} 
                          className="role-item" 
                          draggable
                          onDragStart={(e) => handleDragStart(e, index)}
                          onDragOver={(e) => handleDragOver(e, index)}
                          onDragLeave={handleDragLeave}
                          onDrop={(e) => handleDrop(e, index)}
                          onDragEnd={handleDragEnd}
                          style={{ 
                            padding: '1rem',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '1rem',
                            cursor: 'grab',
                            opacity: draggedIndex === index ? 0.5 : 1,
                            border: dragOverIndex === index ? '2px solid var(--primary-color)' : '1px solid var(--border-color)',
                            transition: 'opacity 0.2s, border 0.2s',
                          }}
                        >
                          <span style={{ 
                            fontSize: '0.85rem', 
                            color: '#999', 
                            minWidth: '2rem',
                            textAlign: 'center',
                            fontWeight: 500
                          }}>
                            #{index + 1}
                          </span>
                          <div style={{ flex: 1, minWidth: 0 }}>
                            <div className="role-name" style={{ 
                              lineHeight: 1.5, 
                              marginBottom: q.authorUsername ? '0.25rem' : 0,
                              wordWrap: 'break-word',
                              overflowWrap: 'break-word',
                              whiteSpace: 'pre-wrap',
                            }}>
                              {q.text}
                            </div>
                            {q.authorUsername && (
                              <div style={{ fontSize: '0.85rem', color: '#999', fontStyle: 'italic' }}>
                                by @{q.authorUsername}
                              </div>
                            )}
                          </div>
                          <button 
                            className="btn btn-danger btn-sm" 
                            onClick={() => {
                              if (window.confirm(`Delete this question?\n\n"${q.text}"`)) {
                                deleteQuestionMutation.mutate(q.id);
                              }
                            }}
                            style={{ minWidth: '80px' }}
                          >
                            Delete
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                {questions && questions.length === 0 && (
                  <div style={{
                    padding: '2rem',
                    textAlign: 'center',
                    background: 'var(--card-bg)',
                    borderRadius: '8px',
                    border: '2px dashed var(--border-color)',
                    color: '#999'
                  }}>
                    <div style={{ fontSize: '3rem', marginBottom: '0.5rem' }}>ğŸ“</div>
                    <div style={{ fontSize: '1.1rem', marginBottom: '0.25rem' }}>No questions yet</div>
                    <div style={{ fontSize: '0.9rem' }}>Add your first question above or upload a CSV file</div>
                  </div>
                )}
              </div>
            </section>
          </>
        )}

        {/* Submissions - guild-wide, shown regardless of channel selection */}
        {(submissions && submissions.length > 0) && (
          <section className="action-card" style={{ marginTop: '1rem' }}>
            <h3>Pending User Submissions ({submissions.length})</h3>
            <p className="section-description">Users submitted these questions via <code>/qotd-submit</code>. Select a channel above, then approve submissions to add them to that channel.</p>
            {!selectedChannelId && (
              <div className="info-notice" style={{ marginTop: '0.5rem', marginBottom: '1rem' }}>
                âš ï¸ Select a channel above to approve submissions
              </div>
            )}
            <div className="role-list">
              {submissions.map((sub) => (
                <div key={sub.id} className="role-item">
                  <span className="role-name">{sub.text}</span>
                  <span style={{ fontSize: '0.85rem', color: '#999', marginLeft: '0.5rem' }}>by {sub.username}</span>
                  {selectedChannelId && (
                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                      <button className="btn btn-primary btn-sm" onClick={async () => {
                        try {
                          await qotdApi.approve(guildId!, selectedChannelId!, sub.id, selectedStreamId || undefined);
                          const streamName = streams?.find(s => s.id === selectedStreamId)?.streamName || 'stream';
                          setQuestionMessage(`âœ“ Approved and added to ${streamName} in ${getChannelName(selectedChannelId)}`);
                          qc.invalidateQueries({ queryKey: ['qotd-submissions', guildId] });
                          qc.invalidateQueries({ queryKey: ['qotd-stream-questions', guildId, selectedChannelId, selectedStreamId] });
                          setTimeout(() => setQuestionMessage(''), 5000);
                        } catch {
                          setQuestionMessage('âœ— Failed to approve');
                          setTimeout(() => setQuestionMessage(''), 5000);
                        }
                      }}>Approve</button>
                      <button className="btn btn-danger btn-sm" onClick={async () => {
                        try {
                          await qotdApi.reject(guildId!, sub.id);
                          setQuestionMessage('âœ“ Rejected');
                          qc.invalidateQueries({ queryKey: ['qotd-submissions', guildId] });
                          setTimeout(() => setQuestionMessage(''), 5000);
                        } catch {
                          setQuestionMessage('âœ— Failed to reject');
                          setTimeout(() => setQuestionMessage(''), 5000);
                        }
                      }}>Reject</button>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </section>
            )}
          </main>
        </div>
      </div>
    </div>
  );
}
