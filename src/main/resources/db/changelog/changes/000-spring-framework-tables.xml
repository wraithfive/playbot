<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Spring Session tables - normally auto-created, now managed by Liquibase -->
    
    <changeSet id="000-create-spring-session-table" author="nwatson">
        <preConditions onFail="CONTINUE">
            <not>
                <tableExists tableName="SPRING_SESSION"/>
            </not>
        </preConditions>
        
        <comment>Create SPRING_SESSION table for persistent HTTP sessions</comment>
        
        <createTable tableName="SPRING_SESSION">
            <column name="PRIMARY_ID" type="char(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="SESSION_ID" type="char(36)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="CREATION_TIME" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="LAST_ACCESS_TIME" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="MAX_INACTIVE_INTERVAL" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="EXPIRY_TIME" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="PRINCIPAL_NAME" type="varchar(100)"/>
        </createTable>
        
        <createIndex indexName="SPRING_SESSION_IX1" tableName="SPRING_SESSION">
            <column name="SESSION_ID"/>
        </createIndex>
        
        <createIndex indexName="SPRING_SESSION_IX2" tableName="SPRING_SESSION">
            <column name="EXPIRY_TIME"/>
        </createIndex>
        
        <createIndex indexName="SPRING_SESSION_IX3" tableName="SPRING_SESSION">
            <column name="PRINCIPAL_NAME"/>
        </createIndex>
    </changeSet>

    <changeSet id="000-create-spring-session-attributes-table" author="nwatson">
        <preConditions onFail="CONTINUE">
            <not>
                <tableExists tableName="SPRING_SESSION_ATTRIBUTES"/>
            </not>
        </preConditions>
        
        <comment>Create SPRING_SESSION_ATTRIBUTES table for session attribute storage</comment>
        
        <createTable tableName="SPRING_SESSION_ATTRIBUTES">
            <column name="SESSION_PRIMARY_ID" type="char(36)">
                <constraints nullable="false"/>
            </column>
            <column name="ATTRIBUTE_NAME" type="varchar(200)">
                <constraints nullable="false"/>
            </column>
            <column name="ATTRIBUTE_BYTES" type="blob">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addPrimaryKey tableName="SPRING_SESSION_ATTRIBUTES" 
                       columnNames="SESSION_PRIMARY_ID, ATTRIBUTE_NAME"
                       constraintName="SPRING_SESSION_ATTRIBUTES_PK"/>
        
        <addForeignKeyConstraint baseTableName="SPRING_SESSION_ATTRIBUTES"
                                 baseColumnNames="SESSION_PRIMARY_ID"
                                 constraintName="SPRING_SESSION_ATTRIBUTES_FK"
                                 referencedTableName="SPRING_SESSION"
                                 referencedColumnNames="PRIMARY_ID"
                                 onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="000-create-oauth2-authorized-client-table" author="nwatson">
        <preConditions onFail="CONTINUE">
            <not>
                <tableExists tableName="oauth2_authorized_client"/>
            </not>
        </preConditions>
        
        <comment>Create oauth2_authorized_client table for OAuth2 token storage</comment>
        
        <createTable tableName="oauth2_authorized_client">
            <column name="client_registration_id" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="principal_name" type="varchar(200)">
                <constraints nullable="false"/>
            </column>
            <column name="access_token_type" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="access_token_value" type="blob">
                <constraints nullable="false"/>
            </column>
            <column name="access_token_issued_at" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="access_token_expires_at" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="access_token_scopes" type="varchar(1000)"/>
            <column name="refresh_token_value" type="blob"/>
            <column name="refresh_token_issued_at" type="timestamp"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addPrimaryKey tableName="oauth2_authorized_client"
                       columnNames="client_registration_id, principal_name"
                       constraintName="oauth2_authorized_client_pk"/>
    </changeSet>

</databaseChangeLog>
